<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Talent's Companion</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    /* === RESET & BASE === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { zoom: 0.9; }
    body { overflow-y: auto; }
    body {
      font-family: 'Inter', sans-serif;
      background: #050d14;
      color: #c8dde8;
    }

    /* === LAYOUT === */
    #app {
      display: grid;
      grid-template-rows: auto auto;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(180deg, #071824 0%, #050d14 100%);
      border-bottom: 1px solid #1a3a4a;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    header h1 {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      color: #a8d8e8;
      letter-spacing: 0.1em;
    }
    .columns {
      display: grid;
      grid-template-columns: 260px 1fr 300px;
      gap: 1px;
      background: #0a1a24;
      align-items: start;
      position: relative;
    }
    .panel {
      background: #060f18;
      padding: 16px;
    }
    .panel + .panel {
      border-left: 1px solid #0f2535;
    }
    .panel-title {
      font-family: 'Cinzel', serif;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #4a7a8a;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid #0f2535;
    }

    /* === HP BARS === */
    .hp-section { margin-bottom: 20px; }
    .hp-label {
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #4a7a8a;
      margin-bottom: 4px;
    }
    .hp-bar-track {
      height: 10px;
      background: #0a1e2a;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 6px;
      border: 1px solid #0f2535;
    }
    .hp-bar-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.3s ease;
    }
    .hp-bar-fill.hp-healthy  { background: linear-gradient(90deg, #0a4a3a, #20c878); }
    .hp-bar-fill.hp-hurt     { background: linear-gradient(90deg, #4a3a00, #c8a020); }
    .hp-bar-fill.hp-critical { background: linear-gradient(90deg, #4a0a0a, #d02020); }
    .hp-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .hp-display { font-size: 1.1rem; color: #e8f4f8; min-width: 80px; }
    .btn-sm {
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #8ab8c8;
      padding: 3px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }
    .btn-sm:hover { background: #0f2d40; border-color: #2ab8d0; color: #c8dde8; }
    .temp-hp { font-size: 0.75rem; color: #7ab0c0; margin-top: 2px; }

    .divider { border: none; border-top: 1px solid #0f2535; margin: 16px 0; }

    /* === SAVES === */
    .saves-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 12px;
    }
    .save-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      padding: 2px 0;
    }
    .save-name { color: #4a7a8a; text-transform: uppercase; font-size: 0.68rem; letter-spacing: 0.05em; }
    .save-val  { color: #a8d8e8; font-weight: 500; }
    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.82rem;
      padding: 3px 0;
      border-bottom: 1px solid #0a1e2a;
    }
    .stat-label { color: #4a7a8a; }
    .stat-value { color: #d4a843; font-weight: 600; }

    /* === PROFICIENCY PIPS === */
    .prof-pip {
      width: 11px; height: 11px;
      border-radius: 50%;
      border: 1.5px solid #2a6a7a;
      background: #0a1e2a;
      cursor: pointer; flex-shrink: 0;
      transition: all 0.15s;
      display: inline-block;
    }
    .prof-pip:hover { transform: scale(1.25); }
    .prof-pip.prof { background: #2ab8d0; border-color: #2ab8d0; }
    .prof-pip.expertise {
      background: #2ab8d0; border-color: #2ab8d0;
      box-shadow: 0 0 0 2px #050d14, 0 0 0 4px #2ab8d0;
    }
    .rest-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .btn-rest {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #1a3a4a;
      background: #0a1e2a;
      color: #8ab8c8;
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.15s;
    }
    .btn-rest:hover { background: #0f2d40; border-color: #2ab8d0; color: #c8dde8; }
    .btn-rest.long { border-color: #d4a84340; color: #d4a843; }
    .btn-rest.long:hover { background: #1a1000; border-color: #d4a843; }

    /* === POLISH === */
    header {
      box-shadow: 0 2px 20px #2ab8d010;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #2ab8d0, #d4a843, #2ab8d0, transparent);
      z-index: 100;
    }
    .panel::-webkit-scrollbar { width: 4px; }
    .panel::-webkit-scrollbar-track { background: transparent; }
    .panel::-webkit-scrollbar-thumb { background: #1a3a4a; border-radius: 2px; }

    /* Danger flash on enemy card at 0 HP */
    .enemy-card.dead {
      border-color: #4a1010;
      opacity: 0.6;
    }


    /* === STAT BLOCK PANEL (floating) === */
    #stat-panel {
      display: none;
      position: fixed;
      right: 20px;
      top: 70px;
      width: 680px;
      height: 860px;
      display: none;
      flex-direction: column;
      background: #040b12;
      border: 1px solid #1a3a4a;
      border-radius: 6px 6px 3px 3px;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,0.7);
      z-index: 100;
      min-width: 280px;
      min-height: 160px;
    }
    #stat-panel.open { display: flex; }
    #stat-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      height: 38px;
      background: #071824;
      border-bottom: 1px solid #1a3a4a;
      cursor: grab;
      user-select: none;
      flex-shrink: 0;
    }
    #stat-titlebar:active { cursor: grabbing; }
    .stat-panel-title {
      font-family: 'Cinzel', serif;
      font-size: 0.62rem;
      color: #4a7a8a;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    #stat-close-btn {
      background: none;
      border: 1px solid #1a3a4a;
      color: #4a7a8a;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s, color 0.15s;
      line-height: 1;
    }
    #stat-close-btn:hover { border-color: #c04040; color: #c04040; }
    #stat-panel.minimized { height: 38px !important; }
    #stat-minimize-btn {
      background: none;
      border: 1px solid #1a3a4a;
      color: #4a7a8a;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s, color 0.15s;
      line-height: 1;
      padding-bottom: 2px;
    }
    #stat-minimize-btn:hover { border-color: #2ab8d0; color: #2ab8d0; }
    #drag-shield {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 101;
    }
    #drag-shield.active { display: block; }
    .panel-resize-handle { position: absolute; z-index: 10; }
    .panel-resize-n  { top: 0;    left: 12px;  height: 5px; width: calc(100% - 24px); cursor: ns-resize; }
    .panel-resize-e  { right: 0;  top: 12px;   width: 5px; height: calc(100% - 24px); cursor: ew-resize; }
    .panel-resize-w  { left: 0;   top: 12px;   width: 5px; height: calc(100% - 24px); cursor: ew-resize; }
    .panel-resize-s  { bottom: 0; left: 12px;  height: 5px; width: calc(100% - 24px); cursor: ns-resize; }
    .panel-resize-nw { top: 0;    left: 0;     width: 12px; height: 12px; cursor: nwse-resize; }
    .panel-resize-ne { top: 0;    right: 0;    width: 12px; height: 12px; cursor: nesw-resize; }
    .panel-resize-se { right: 0;  bottom: 0;   width: 12px; height: 12px; cursor: nwse-resize; }
    .panel-resize-sw { left: 0;   bottom: 0;   width: 12px; height: 12px; cursor: nesw-resize; }
    #stat-zoom-controls {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 4px 14px;
      background: #050d14;
      border-bottom: 1px solid #0a1e2a;
      flex-shrink: 0;
    }
    #stat-zoom-controls.visible { display: flex; }
    .stat-tab-btn.active { border-color: #2ab8d0; color: #2ab8d0; background: #071824; }
    .zoom-label {
      font-size: 0.65rem;
      color: #4a7a8a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      min-width: 36px;
      text-align: center;
    }
    #stat-preview {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px 12px;
      background: #040b12;
      min-height: 0;
    }
    #stat-preview::-webkit-scrollbar { width: 4px; }
    #stat-preview::-webkit-scrollbar-thumb { background: #1a3a4a; border-radius: 2px; }
    #stat-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      display: block;
    }
    #stat-preview embed {
      width: min(700px, 92%);
      height: 1100px;
      border: none;
      display: block;
    }
    .stat-preview-hint {
      font-size: 0.65rem;
      color: #1a3040;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      text-align: center;
      transition: color 0.2s;
    }
    .stat-preview-hint.drag-over { color: #2ab8d0; }
    #stat-thumbs {
      border-top: 1px solid #0a1e2a;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      overflow-x: auto;
      background: #060f18;
      flex-shrink: 0;
      height: 110px;
    }
    #stat-thumbs::-webkit-scrollbar { height: 3px; }
    #stat-thumbs::-webkit-scrollbar-thumb { background: #1a3a4a; border-radius: 2px; }
    .drop-hint-strip {
      font-size: 0.65rem;
      color: #1e3a4a;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      white-space: nowrap;
      padding: 6px 12px;
      border: 1px dashed #0f2535;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .drop-hint-strip.drag-over { border-color: #2ab8d0; color: #2ab8d0; background: #071824; }
    .stat-card {
      flex-shrink: 0;
      width: 56px;
      cursor: pointer;
      text-align: center;
      transition: transform 0.15s;
    }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card-thumb {
      width: 56px;
      height: 68px;
      border-radius: 5px;
      border: 1px solid #1a3a4a;
      overflow: hidden;
      background: #071824;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 3px;
      transition: border-color 0.15s;
    }
    .stat-card.active .stat-card-thumb { border-color: #2ab8d0; box-shadow: 0 0 8px #2ab8d040; }
    .stat-card:hover .stat-card-thumb { border-color: #2ab8d060; }
    .stat-card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .pdf-icon-thumb { font-size: 1.4rem; opacity: 0.5; }
    .stat-card-remove {
      position: absolute;
      top: 2px; right: 2px;
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #4a7a8a;
      border-radius: 50%;
      width: 15px; height: 15px;
      font-size: 0.5rem;
      line-height: 14px;
      text-align: center;
      cursor: pointer;
      opacity: 0.45;
      transition: opacity 0.15s;
    }
    .stat-card:hover .stat-card-remove { opacity: 1; }
    .stat-card-remove:hover { color: #d04040; border-color: #d04040; }
    .stat-card-name {
      font-size: 0.52rem;
      color: #4a7a8a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 56px;
    }

    /* === REST DROPDOWN === */
    .rest-dropdown-wrap {
      position: relative;
    }
    .rest-menu-btn {
      background: none;
      border: 1px solid #1a3a4a;
      color: #5a8a9a;
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }
    .rest-menu-btn:hover { border-color: #2ab8d0; color: #a8d8e8; }
    .rest-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 4px;
      min-width: 130px;
      z-index: 200;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .rest-menu.hidden { display: none; }
    .rest-menu button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      color: #a8d8e8;
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem;
      padding: 8px 14px;
      text-align: left;
      cursor: pointer;
      border-bottom: 1px solid #0f2535;
      transition: background 0.1s;
    }
    .rest-menu button:last-child { border-bottom: none; }
    .rest-menu button:hover { background: #0f2535; }

    /* === INVENTORY & MAGIC ITEMS === */
    .inventory-item {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 0; border-bottom: 1px solid #0a1e2a;
      font-size: 0.8rem; color: #c8dde8;
    }
    .inventory-item:last-child { border-bottom: none; }
    .inv-name { flex: 1; cursor: pointer; }
    .inv-name:hover { color: #2ab8d0; }
    .inv-qty { color: #4a7a8a; font-size: 0.75rem; min-width: 28px; text-align: right; }
    .btn-remove-inv {
      background: none; border: none; color: #2a4a5a;
      cursor: pointer; font-size: 0.8rem; padding: 0 2px;
    }
    .btn-remove-inv:hover { color: #d05050; }
    .btn-add-inv {
      width: 100%; margin-top: 6px;
      background: #071824; border: 1px dashed #1a3a4a;
      color: #4a7a8a; border-radius: 4px; padding: 5px;
      cursor: pointer; font-size: 0.75rem; letter-spacing: 0.05em;
    }
    .btn-add-inv:hover { border-color: #2ab8d0; color: #2ab8d0; }
    .collapsible-title {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none;
    }

    /* === MAGIC ITEMS === */
    .magic-item {
      background: #071824; border: 1px solid #0f2535;
      border-radius: 4px; padding: 7px 10px; margin-bottom: 6px;
    }
    .magic-item-header {
      display: flex; align-items: center; gap: 6px; margin-bottom: 5px;
    }
    .magic-item-name {
      flex: 1; font-size: 0.8rem; color: #a8d8e8; cursor: pointer;
    }
    .magic-item-name:hover { color: #2ab8d0; }
    .magic-item-actions { display: flex; gap: 4px; }
    .btn-toggle {
      background: #0a1e2a; border: 1px solid #1a3a4a;
      color: #4a7a8a; font-size: 0.65rem; letter-spacing: 0.05em;
      padding: 2px 7px; border-radius: 3px; cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
      text-transform: uppercase;
    }
    .btn-toggle.active-equipped { background: #0a2a1a; border-color: #20a850; color: #20a850; }
    .btn-toggle.active-attuned  { background: #1a1a2a; border-color: #7070d8; color: #9090e8; }
    .btn-remove-magic {
      background: none; border: none; color: #2a4a5a; cursor: pointer; font-size: 0.8rem;
    }
    .btn-remove-magic:hover { color: #d05050; }

    /* === ATTUNED SECTION === */
    .attuned-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .attuned-counter { font-size: 0.8rem; color: #9090e8; }
    .attuned-counter.over { color: #d05050; }
    .attuned-item-row {
      display: flex; align-items: center; gap: 6px;
      padding: 3px 0; font-size: 0.78rem; color: #a8d8e8;
      border-bottom: 1px solid #0a1e2a;
    }
    .attuned-item-row:last-child { border-bottom: none; }
    .attuned-dot { width: 6px; height: 6px; border-radius: 50%; background: #7070d8; flex-shrink: 0; }
    .btn-add-attunement-slot {
      width: 100%; margin-top: 8px;
      background: none; border: 1px dashed #3a3a6a;
      color: #4a4a9a; border-radius: 4px; padding: 4px;
      cursor: pointer; font-size: 0.72rem;
    }
    .btn-add-attunement-slot:hover { border-color: #9090e8; color: #9090e8; }

    /* === FORMULA DROPDOWN === */
    .formula-dropdown-wrap { position: relative; }
    .formula-dropdown-btn {
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #8ab8c8;
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      letter-spacing: 0.04em;
    }
    .formula-dropdown-btn:hover { border-color: #2ab8d0; color: #2ab8d0; }
    .formula-panel {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 4px;
      padding: 10px 14px;
      z-index: 100;
      min-width: 280px;
      font-size: 0.75rem;
      line-height: 1.8;
      color: #8ab8c8;
      white-space: nowrap;
    }
    .formula-panel.open { display: block; }
    .formula-row { display: flex; gap: 8px; }
    .formula-lhs { color: #4a7a8a; min-width: 90px; }

    /* === CUSTOM ATTACKS === */
    .attack-entry {
      background: #071824;
      border: 1px solid #0f2535;
      border-radius: 4px;
      padding: 8px 10px;
      margin-bottom: 8px;
    }
    .attack-entry-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .attack-name {
      font-family: 'Cinzel', serif;
      font-size: 0.8rem;
      color: #a8d8e8;
      cursor: pointer;
    }
    .attack-name:hover { color: #2ab8d0; }
    .attack-stats { font-size: 0.75rem; color: #8ab8c8; margin-bottom: 3px; }
    .attack-notes { font-size: 0.7rem; color: #4a7a8a; font-style: italic; }
    .btn-remove-attack {
      background: none; border: none; color: #3a6a7a;
      cursor: pointer; font-size: 0.85rem; padding: 0 4px;
    }
    .btn-remove-attack:hover { color: #d05050; }
    .btn-add-attack {
      width: 100%; margin-top: 6px;
      background: #071824; border: 1px dashed #1a3a4a;
      color: #4a7a8a; border-radius: 4px; padding: 6px;
      cursor: pointer; font-size: 0.75rem; letter-spacing: 0.05em;
    }
    .btn-add-attack:hover { border-color: #2ab8d0; color: #2ab8d0; }

    /* === LORE BOOK PANEL === */
    #lore-panel {
      display: none;
      position: fixed;
      left: 20px;
      top: 70px;
      width: 680px;
      height: 860px;
      flex-direction: column;
      background: #040b12;
      border: 1px solid #1a3a4a;
      border-radius: 6px 6px 3px 3px;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,0.7);
      z-index: 100;
      min-width: 280px;
      min-height: 160px;
    }
    #lore-panel.open { display: flex; }
    #lore-panel.minimized { height: 38px !important; }
    #lore-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      height: 38px;
      background: #071824;
      border-bottom: 1px solid #1a3a4a;
      cursor: grab;
      user-select: none;
      flex-shrink: 0;
    }
    #lore-titlebar:active { cursor: grabbing; }
    .lore-panel-title {
      font-family: 'Cinzel', serif;
      font-size: 0.62rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #4a8a9a;
    }
    #lore-subheader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-bottom: 1px solid #0c2535;
      background: #050f1a;
      flex-shrink: 0;
    }
    #lore-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 8px;
    }
    #lore-empty {
      font-size: 0.8rem;
      color: #2a5a6a;
      text-align: center;
      margin-top: 40px;
      font-style: italic;
    }
    #lore-textarea {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #8ab8c8;
      font-size: 0.82rem;
      line-height: 1.7;
      resize: none;
      font-family: inherit;
      width: 100%;
    }
    #lore-footer {
      display: flex;
      gap: 8px;
      padding: 8px 10px;
      border-top: 1px solid #0c2535;
      background: #050f1a;
      flex-shrink: 0;
    }
    .stat-panel-btn {
      background: none;
      border: 1px solid #1a3a4a;
      color: #4a7a8a;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s, color 0.15s;
      line-height: 1;
      padding: 0;
    }
    .stat-panel-btn:hover { border-color: #2ab8d0; color: #2ab8d0; }

    /* === ACTIVE SPELLS === */
    .active-spell {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.72rem;
      background: #0a1a24;
      margin-bottom: 4px;
      border: 1px solid #0f2535;
    }
    .spell-name { flex: 1; color: #c8dde8; }
    .conc-badge {
      font-size: 0.58rem;
      padding: 1px 4px;
      border-radius: 3px;
      background: #2a1a3a;
      color: #b088d8;
      border: 1px solid #6040a0;
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    .spell-remove {
      background: none;
      border: none;
      color: #3a5a6a;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0 2px;
      transition: color 0.15s;
    }
    .spell-remove:hover { color: #d04040; }
    .no-spells {
      font-size: 0.65rem;
      color: #1e3a4a;
      font-style: italic;
      text-align: center;
      padding: 6px 0 2px;
    }

    /* === STRAIN TRACKER === */
    .strain-section { margin-bottom: 20px; }
    .strain-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .strain-label {
      font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase;
      width: 40px; font-weight: 600;
    }
    .strain-label.body { color: #FF4DA6; }
    .strain-label.mind { color: #4DD9FF; }
    .strain-label.soul { color: #9B59FF; }
    .strain-pips { display: flex; gap: 3px; flex: 1; }
    .strain-pip {
      font-size: 0.9rem; cursor: pointer; opacity: 0.2;
      transition: opacity 0.15s, filter 0.15s;
      user-select: none;
    }
    .strain-pip.filled { opacity: 1; }
    .strain-pip.filled.body  { filter: drop-shadow(0 0 4px #FF4DA6); }
    .strain-pip.filled.mind  { filter: drop-shadow(0 0 4px #4DD9FF); }
    .strain-pip.filled.soul  { filter: drop-shadow(0 0 4px #9B59FF); }
    .strain-adj { background: none; border: 1px solid #1a3a4a; color: #4a7a8a;
      border-radius: 3px; width: 20px; height: 20px; font-size: 0.75rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .strain-adj:hover { border-color: #a8d8e8; color: #a8d8e8; }
    .strain-total {
      font-size: 0.75rem; text-align: center; margin-bottom: 8px;
      color: #4a7a8a; letter-spacing: 0.05em;
    }
    .strain-total.warning { color: #d04040; animation: pulse 1s infinite; }
    .strain-total strong { color: #c8dde8; }
    .manifest-die-display {
      font-size: 0.7rem; color: #4a7a8a; text-align: center; margin-top: 4px;
    }
    .manifest-die-display span { color: #FF4DA6; font-weight: 600; }

    /* === ACTIVE POWERS === */
    .powers-section { margin-bottom: 20px; }
    .power-card {
      background: #07131c; border: 1px solid #0f2535;
      border-radius: 4px; padding: 8px 10px; margin-bottom: 6px;
      display: flex; align-items: center; gap: 8px;
    }
    .power-card:hover { border-color: #1a3a4a; }
    .power-order-badge {
      font-size: 0.6rem; background: #0a1e2a; border: 1px solid #1a3a4a;
      border-radius: 3px; padding: 2px 5px; color: #4a7a8a;
      white-space: nowrap; font-family: 'Cinzel', serif;
    }
    .power-name { flex: 1; font-size: 0.8rem; color: #c8dde8; }
    .power-school { font-size: 0.6rem; color: #4a7a8a; text-transform: uppercase; letter-spacing: 0.08em; }
    .power-conc-toggle {
      font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; cursor: pointer;
      border: 1px solid #1a3a4a; background: none; color: #4a7a8a;
    }
    .power-conc-toggle.active { border-color: #FF4DA6; color: #FF4DA6; }
    .power-manifest-btn {
      font-size: 0.65rem; padding: 3px 8px; border-radius: 3px; cursor: pointer;
      background: #0a1e2a; border: 1px solid #1a4a6a; color: #a8d8e8;
    }
    .power-manifest-btn:hover { background: #1a3a4a; }
    .powers-manage-btn {
      width: 100%; font-size: 0.7rem; padding: 6px; margin-top: 4px;
      background: none; border: 1px dashed #1a3a4a; border-radius: 4px;
      color: #4a7a8a; cursor: pointer; letter-spacing: 0.05em;
    }
    .powers-manage-btn:hover { border-color: #a8d8e8; color: #a8d8e8; }

    /* === MANAGE POWERS MODAL === */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-box {
      background: #060f18; border: 1px solid #1a3a4a; border-radius: 8px;
      max-width: 600px; width: 95vw; max-height: 80vh;
      display: flex; flex-direction: column;
    }
    .modal-header {
      flex-shrink: 0; padding: 16px 20px 0;
    }
    .modal-body {
      flex: 1; overflow-y: auto; padding: 0 20px 4px;
    }
    .modal-footer {
      flex-shrink: 0; padding: 10px 20px;
      border-top: 1px solid #0f2535;
    }
    .modal-title {
      font-family: 'Cinzel', serif; font-size: 1rem; color: #a8d8e8;
      margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #0f2535;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-close {
      background: none; border: none; color: #4a7a8a; font-size: 1.2rem;
      cursor: pointer; padding: 0 4px;
    }
    .modal-close:hover { color: #d04040; }
    .order-group { margin-bottom: 16px; }
    .order-group-title {
      font-family: 'Cinzel', serif; font-size: 0.7rem; color: #4a7a8a;
      text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #071320;
    }
    .power-pick-row {
      display: flex; align-items: center; gap: 8px; padding: 4px 0;
      border-bottom: 1px solid #071320;
    }
    .power-pick-row:last-child { border-bottom: none; }
    .power-pick-checkbox { accent-color: #FF4DA6; width: 14px; height: 14px; cursor: pointer; }
    .power-pick-name { flex: 1; font-size: 0.8rem; color: #c8dde8; }
    .power-pick-school { font-size: 0.65rem; color: #4a7a8a; text-transform: uppercase; }
    .power-pick-time { font-size: 0.65rem; color: #2a6a7a; }
    .modal-search {
      width: 100%; background: #07131c; border: 1px solid #1a3a4a; color: #c8dde8;
      border-radius: 4px; padding: 6px 10px; font-size: 0.8rem; margin-bottom: 12px;
      box-sizing: border-box;
    }
    .school-filter { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
    .school-btn {
      font-size: 0.65rem; padding: 3px 8px; border-radius: 12px; cursor: pointer;
      border: 1px solid #1a3a4a; background: none; color: #4a7a8a;
    }
    .school-btn.active { background: #0a1e2a; border-color: #FF4DA6; color: #FF4DA6; }

    /* === MANIFEST RESOLVER === */
    .resolver-box { max-width: 400px; padding: 20px; }
    .resolver-step { margin-bottom: 16px; }
    .resolver-score {
      font-size: 1.4rem; text-align: center; font-family: 'Cinzel', serif;
      color: #a8d8e8; margin: 8px 0;
    }
    .resolver-score small { font-size: 0.7rem; color: #4a7a8a; display: block; }
    .resolver-roll-btn {
      width: 100%; padding: 12px; font-size: 1rem; border-radius: 4px;
      background: #0a1e2a; border: 1px solid #1a4a6a; color: #a8d8e8;
      cursor: pointer; font-family: 'Cinzel', serif; letter-spacing: 0.1em;
    }
    .resolver-roll-btn:hover { background: #1a3a4a; }
    .resolver-result {
      text-align: center; padding: 12px; border-radius: 4px; margin: 12px 0;
      font-size: 0.9rem;
    }
    .resolver-result.success { background: #0a2a0a; border: 1px solid #1a6a1a; color: #4ada4a; }
    .resolver-result.partial { background: #2a2a0a; border: 1px solid #6a6a1a; color: #dada4a; }
    .resolver-result.failure { background: #2a0a0a; border: 1px solid #6a1a1a; color: #da4a4a; }
    .resolver-result.death-warning {
      background: #1a0a0a; border: 1px solid #d04040; color: #d04040;
    }
    .strain-alloc { display: flex; gap: 8px; justify-content: center; margin: 12px 0; }
    .strain-alloc-btn {
      padding: 8px 16px; border-radius: 4px; border: 1px solid; cursor: pointer;
      font-size: 0.8rem; background: none;
    }
    .strain-alloc-btn.body { border-color: #FF4DA6; color: #FF4DA6; }
    .strain-alloc-btn.mind { border-color: #4DD9FF; color: #4DD9FF; }
    .strain-alloc-btn.soul { border-color: #9B59FF; color: #9B59FF; }
    .strain-alloc-btn:hover { opacity: 0.8; }
    .alloc-tally { text-align: center; font-size: 0.8rem; color: #4a7a8a; margin-bottom: 8px; }
    .resolver-confirm-btn {
      width: 100%; padding: 10px; border-radius: 4px; cursor: pointer;
      background: #1a3a4a; border: 1px solid #4a7a8a; color: #a8d8e8;
      font-size: 0.85rem;
    }
    .resolver-confirm-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* === EDITABLE STATS === */
    .editable-stat {
      cursor: pointer;
      border-bottom: 1px dashed #3a5a6a;
      transition: color 0.15s, border-color 0.15s;
    }
    .editable-stat:hover { color: #7ad4e8; border-bottom-color: #7ad4e8; }

    /* === SENSES PANEL === */
    .senses-grid { margin-top: 8px; }

    /* === IMMUNITIES & RESISTANCES === */
    .imm-summary {
      display: grid;
      grid-template-columns: 52px 1fr;
      gap: 3px 6px;
      margin-bottom: 6px;
    }
    .imm-row-label {
      font-size: 0.62rem;
      color: #4a7a8a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding-top: 2px;
    }
    .imm-tags { display: flex; flex-wrap: wrap; gap: 3px; }
    .imm-tag {
      font-size: 0.6rem;
      padding: 1px 5px;
      border-radius: 3px;
      font-family: 'Inter', sans-serif;
    }
    .imm-tag.imm { background: #3a1a1a; color: #e87070; border: 1px solid #7a3030; }
    .imm-tag.res { background: #1a2a3a; color: #70aae8; border: 1px solid #305070; }
    .imm-none { font-size: 0.62rem; color: #3a5a6a; font-style: italic; }
    .imm-picker {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 8px;
      background: #0e1e28;
      border: 1px solid #1e3a4a;
      border-radius: 4px;
      padding: 8px;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    .imm-col-head {
      font-size: 0.6rem;
      color: #4a7a8a;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding-bottom: 4px;
      border-bottom: 1px solid #1e3a4a;
      margin-bottom: 2px;
    }
    .imm-check {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.65rem;
      color: #8ab0bc;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background 0.1s;
    }
    .imm-check:hover { background: #1a3040; }
    .imm-check input { accent-color: #4a9ab0; cursor: pointer; }
    .imm-check.active-imm { color: #e87070; }
    .imm-check.active-res { color: #70aae8; }

    /* === CONDITIONS PANEL === */
    .cond-section { margin-top: 0; }
    .cond-add-row {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }
    .cond-add-row select {
      flex: 1;
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #c8dde8;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-family: 'Inter', sans-serif;
      appearance: none;
      cursor: pointer;
    }
    .cond-add-row select:focus { outline: none; border-color: #2ab8d0; }
    .cond-dur-input {
      width: 44px;
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #c8dde8;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-family: 'Inter', sans-serif;
      text-align: center;
    }
    .cond-dur-input:focus { outline: none; border-color: #2ab8d0; }
    .btn-cond-add {
      background: #071824;
      border: 1px solid #1a4a5a;
      color: #2ab8d0;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn-cond-add:hover { background: #0a2535; border-color: #2ab8d0; }
    .cond-custom-row {
      display: none;
      gap: 4px;
      margin-bottom: 8px;
    }
    .cond-custom-row.visible { display: flex; }
    .cond-list { margin-bottom: 6px; }
    .cond-item {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 6px;
      border-radius: 4px;
      background: #0a1a24;
      border: 1px solid #0f2535;
      margin-bottom: 3px;
      font-size: 0.72rem;
    }
    .cond-name {
      flex: 1;
      color: #c8dde8;
      font-weight: 500;
    }
    .cond-dur {
      font-size: 0.65rem;
      color: #4a7a8a;
      min-width: 28px;
      text-align: right;
    }
    .cond-dur.permanent { color: #2ab8d0; }
    .cond-remove {
      background: none;
      border: none;
      color: #3a5a6a;
      cursor: pointer;
      font-size: 0.72rem;
      padding: 0 2px;
      line-height: 1;
      transition: color 0.15s;
    }
    .cond-remove:hover { color: #d04040; }
    .no-conds {
      font-size: 0.65rem;
      color: #1e3a4a;
      font-style: italic;
      text-align: center;
      padding: 4px 0 2px;
    }
    .btn-next-turn {
      width: 100%;
      padding: 6px;
      background: #071824;
      border: 1px solid #1a4a5a;
      border-radius: 4px;
      color: #4a7a8a;
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      transition: all 0.15s;
      margin-top: 2px;
    }
    .btn-next-turn:hover { background: #0a2535; border-color: #2ab8d0; color: #2ab8d0; }

    /* === COLUMN DRAG HANDLES === */
    .col-handle {
      position: absolute;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background: transparent;
      transform: translateX(-50%);
    }
    .col-handle::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 0;
      width: 2px;
      height: 100%;
      background: #0f2535;
      transition: background 0.15s;
    }
    .col-handle:hover::after,
    .col-handle.dragging::after { background: #2ab8d0; }

    /* === SECTION EDIT MODE === */
    .edit-pencil-btn {
      background: none;
      border: none;
      color: #2a5a6a;
      cursor: pointer;
      font-size: 0.7rem;
      padding: 0 4px;
      opacity: 0.65;
      transition: opacity 0.15s, color 0.15s;
      line-height: 1;
    }
    .edit-pencil-btn:hover { opacity: 1; color: #2ab8d0; }
    .section-edit-controls { display: flex; gap: 4px; align-items: center; }
    .edit-save-btn {
      font-family: 'Inter', sans-serif;
      font-size: 0.6rem;
      padding: 2px 8px;
      background: #0a3a2a;
      border: 1px solid #20a860;
      color: #20a860;
      border-radius: 3px;
      cursor: pointer;
      letter-spacing: 0.04em;
    }
    .edit-save-btn:hover { background: #0d4a34; }
    .edit-cancel-btn {
      font-family: 'Inter', sans-serif;
      font-size: 0.6rem;
      padding: 2px 6px;
      background: none;
      border: 1px solid #3a2020;
      color: #6a3a3a;
      border-radius: 3px;
      cursor: pointer;
    }
    .edit-cancel-btn:hover { border-color: #c04040; color: #c04040; }
    .edit-input-sm {
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      border-bottom-color: #2ab8d0;
      color: #c8dde8;
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      padding: 1px 4px;
      border-radius: 3px 3px 0 0;
      width: 54px;
      text-align: center;
    }
    .edit-input-sm:focus { outline: none; border-color: #2ab8d0; }
    .edit-input-wide { width: 110px; text-align: left; }

    /* === DICE ROLLER === */
    .dice-dropdown-wrap { position: relative; }
    .dice-dropdown-btn {
      background: none;
      border: 1px solid #1a3a4a;
      color: #a8d8e8;
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
      letter-spacing: 0.04em;
    }
    .dice-dropdown-btn:hover { border-color: #2ab8d0; color: #2ab8d0; }
    .dice-panel {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      z-index: 200;
      min-width: 260px;
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 5px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      display: none;
    }
    .dice-panel.open { display: block; }
    .dice-btn-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .btn-die {
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #a8d8e8;
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      padding: 5px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
      letter-spacing: 0.03em;
    }
    .btn-die:hover { border-color: #2ab8d0; color: #2ab8d0; background: #0d2535; }
    .dice-controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.7rem;
      color: #4a7a8a;
    }
    .dice-controls-row input {
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #c8dde8;
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      padding: 3px 6px;
      border-radius: 3px;
      width: 48px;
      text-align: center;
    }
    .dice-result { text-align: center; margin-bottom: 8px; }
    .dice-result-label {
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #4a7a8a;
      margin-bottom: 2px;
    }
    .dice-result-value {
      font-family: 'Cinzel', serif;
      font-size: 1.8rem;
      color: #d4a843;
      line-height: 1;
    }
    .dice-result-detail {
      font-size: 0.65rem;
      color: #4a7a8a;
      margin-top: 2px;
    }
    .dice-history { border-top: 1px solid #0f2535; padding-top: 8px; margin-top: 4px; }
    .dice-history-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      padding: 2px 0;
      color: #3a6a7a;
    }
    .dice-hist-expr { color: #4a7a8a; }
    .dice-hist-val { color: #2a8a8a; }

    /* === MATERIALS DROPDOWN === */
    .materials-dropdown-wrap { position: relative; }
    .materials-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 4px;
      min-width: 180px;
      z-index: 100;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    .materials-menu.hidden { display: none; }
    .materials-menu button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 7px 12px;
      background: none;
      border: none;
      border-bottom: 1px solid #0f2535;
      color: #8ab8c8;
      cursor: pointer;
      font-size: 0.8rem;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .materials-menu button:last-child { border-bottom: none; }
    .materials-menu button:hover { background: #0f2535; color: #a8d8e8; }
    .materials-menu button.mat-active { color: #2ab8d0; }
    .materials-menu .mat-divider { border: none; border-top: 1px solid #0f2535; margin: 2px 0; }

    /* === HELP MODAL === */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .help-overlay.hidden { display: none; }
    .sr-modal {
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 8px;
      padding: 24px;
      max-width: 360px;
      width: 90%;
      position: relative;
    }
    .sr-dice-count {
      font-size: 0.85rem;
      color: #8ab8c8;
      margin-bottom: 14px;
    }
    .sr-picker {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .sr-picker-val {
      font-size: 1.3rem;
      font-weight: 700;
      color: #a8d8e8;
      min-width: 28px;
      text-align: center;
    }
    .sr-roll-list {
      margin-bottom: 14px;
      font-size: 0.82rem;
      color: #8ab8c8;
      line-height: 2;
    }
    .sr-roll-row {
      display: flex;
      justify-content: space-between;
    }
    .sr-total {
      font-size: 0.95rem;
      font-weight: 700;
      color: #a8d8e8;
      margin-bottom: 16px;
    }
    .sr-actions {
      display: flex;
      gap: 8px;
    }
    .help-modal {
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 8px;
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .help-modal h2 {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      color: #a8d8e8;
      margin-bottom: 16px;
      padding-right: 24px;
    }
    .help-modal h3 {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #4a8a9a;
      margin: 14px 0 4px;
    }
    .help-modal p {
      font-size: 0.8rem;
      color: #8ab8c8;
      line-height: 1.5;
    }
    .help-close {
      position: absolute;
      top: 12px;
      right: 14px;
      background: none;
      border: none;
      color: #4a7a8a;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .help-close:hover { color: #a8d8e8; }
    .btn-help {
      background: #0a1e2a;
      border: 1px solid #1a3a4a;
      color: #5a8a9a;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-family: 'Inter', sans-serif;
    }
    .btn-help:hover { border-color: #4a8a9a; color: #a8d8e8; }

    /* === CONDITIONS DROPDOWN === */
    .conditions-dropdown-wrap { position: relative; }
    .conditions-panel {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #071824;
      border: 1px solid #1a3a4a;
      border-radius: 4px;
      width: 300px;
      max-height: 420px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    .conditions-panel.hidden { display: none; }
    .condition-entry {
      padding: 8px 12px;
      border-bottom: 1px solid #0f2535;
    }
    .condition-entry:last-child { border-bottom: none; }
    .condition-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: #a8d8e8;
      margin-bottom: 3px;
    }
    .condition-effect {
      font-size: 0.72rem;
      color: #6a9aaa;
      line-height: 1.45;
    }
  </style>
</head>
<body>
<div id="app">
  <header id="app-header"></header>
  <div class="columns">
    <div class="panel" id="panel-character">
      <div class="panel-title">Character</div>
    </div>
    <div class="panel" id="panel-resources">
      <div id="status-section"></div>
      <hr class="divider">
      <div id="attacks-section-wrap"></div>
      <hr class="divider">
      <div id="strain-section"></div>
      <hr class="divider">
      <div id="powers-section"></div>
    </div>
    <div class="panel" id="panel-right">
      <div id="inventory-wrap"></div>
      <hr class="divider">
      <div id="feats-wrap"></div>
      <hr class="divider">
      <div id="skills-wrap"></div>
    </div>
  </div>
</div>
<div id="help-overlay" class="help-overlay hidden" onclick="closeHelpOnBackdrop(event)">
  <div class="help-modal">
    <button class="help-close" onclick="closeHelp()">‚úï</button>
    <h2>Quick Start Guide</h2>
    <h3>Editing Stats</h3>
    <p>Click any stat value to edit it directly. For sections with a ‚úè icon, click it to open a multi-field edit mode, then click Save.</p>
    <h3>HP</h3>
    <p>Use ‚àí / + to adjust current HP. "Set" jumps to any value. Click the ‚úè icon to edit max HP and temp HP.</p>
    <h3>Spell Slots</h3>
    <p>Click a pip to use or restore a spell slot. All slots refill on Long Rest. Use the ‚úè icon to set your spellcasting ability, Spell Save DC, and Spell Attack bonus.</p>
    <h3>Prepared Spells</h3>
    <p>Below the slot pips, use <strong>+</strong> to add a spell (enter name and level). Click a spell name to expand its notes ‚Äî double-click to edit them. Double-click the spell name to rename it. Remove a spell with ‚úï. Your list persists across sessions and is fully flexible ‚Äî add or remove spells freely.</p>
    <h3>Skills &amp; Saves</h3>
    <p>Click the pip next to a skill or save to cycle proficiency: hollow ‚Üí teal (proficient) ‚Üí ring (expertise).</p>
    <h3>Status</h3>
    <p>Track active spells, HP Effects (Aid, Heroes' Feast, etc.), and conditions. Add them with the + buttons in the Status panel.</p>
    <h3>Inventory</h3>
    <p>Use <strong>+ Item</strong> or <strong>+ Magic</strong> to add items. Expand an item to see its description ‚Äî double-click the description to edit it. Magic items can be toggled Equipped or Attuned.</p>
    <h3>Feats</h3>
    <p>Add feats with <strong>+ Feat</strong>. Expand a feat to view or edit its description ‚Äî double-click the description text to edit it directly. Double-click the feat name to rename it.</p>
    <h3>Short Rest</h3>
    <p>Open the Rests menu and click <strong>Short Rest</strong>. Choose how many hit dice to spend, then click Roll to see individual results (each die + CON modifier). Click Heal to apply the total to your HP and spend the dice. Cancel at any point to do nothing.</p>
    <h3>Lore Book</h3>
    <p>Click <strong>üìñ Lore</strong> in the header to open the floating Lore Book panel. Use <strong>+</strong> to create named pages (NPCs, Locations, Factions, etc.). Click the page dropdown to switch between pages. Use <strong>‚úé</strong> to rename the active page and <strong>‚úï</strong> to delete it. Type directly in the panel to edit ‚Äî content saves automatically. Use <strong>Export</strong> to download your lore as a JSON backup, and <strong>Import</strong> to restore it.</p>
    <h3>Stat Block Viewer</h3>
    <p>Drag a PDF or image onto the page to load a stat block. Drag the viewer panel to reposition it.</p>
    <h3>Saving</h3>
    <p>Everything saves automatically to this browser. Use Export / Import (in the Rests menu) to back up or transfer your character.</p>
  </div>
</div>
<div id="short-rest-overlay" class="help-overlay hidden" onclick="srCloseOnBackdrop(event)">
  <div class="sr-modal">
    <button class="help-close" onclick="closeShortRest()">‚úï</button>
    <h2 style="font-family:'Cinzel',serif;font-size:1rem;color:#a8d8e8;margin-bottom:16px;">Short Rest</h2>
    <div id="sr-body"></div>
  </div>
</div>
<div id="lore-panel">
  <div class="panel-resize-handle panel-resize-n"  onmousedown="startLoreResize(event,'n')"></div>
  <div class="panel-resize-handle panel-resize-e"  onmousedown="startLoreResize(event,'e')"></div>
  <div class="panel-resize-handle panel-resize-w"  onmousedown="startLoreResize(event,'w')"></div>
  <div class="panel-resize-handle panel-resize-s"  onmousedown="startLoreResize(event,'s')"></div>
  <div class="panel-resize-handle panel-resize-nw" onmousedown="startLoreResize(event,'nw')"></div>
  <div class="panel-resize-handle panel-resize-ne" onmousedown="startLoreResize(event,'ne')"></div>
  <div class="panel-resize-handle panel-resize-se" onmousedown="startLoreResize(event,'se')"></div>
  <div class="panel-resize-handle panel-resize-sw" onmousedown="startLoreResize(event,'sw')"></div>
  <div id="lore-titlebar">
    <span class="lore-panel-title">üìñ Lore Book</span>
    <div style="display:flex;gap:4px;align-items:center;">
      <button id="lore-minimize-btn" class="stat-panel-btn" onclick="toggleLoreMinimize()" title="Minimize">‚Äî</button>
      <button class="stat-panel-btn" onclick="toggleLorePanel()" title="Close">‚úï</button>
    </div>
  </div>
  <div id="lore-subheader">
    <div id="lore-page-dropdown-wrap" class="materials-dropdown-wrap">
      <button class="formula-dropdown-btn" onclick="toggleLorePageMenu(event)" id="lore-page-btn">‚Äî no pages ‚Äî</button>
      <div id="lore-page-menu" class="materials-menu hidden"></div>
    </div>
    <div style="display:flex;gap:4px;">
      <button class="btn-sm" onclick="renameLorePage()" title="Rename page">‚úé</button>
      <button class="btn-sm" onclick="deleteLorePage()" title="Delete page">‚úï</button>
      <button class="btn-sm" onclick="addLorePage()">+</button>
    </div>
  </div>
  <div id="lore-content">
    <div id="lore-empty" style="display:none;">No pages yet ‚Äî click + to add one</div>
    <textarea id="lore-textarea" oninput="updateLoreContent(this.value)" placeholder="Write your lore here‚Ä¶"></textarea>
  </div>
  <div id="lore-footer">
    <button class="btn-sm" onclick="exportLore()">Export</button>
    <button class="btn-sm" onclick="importLore()">Import</button>
  </div>
</div>
<div id="drag-shield"></div>
<div id="stat-panel">
  <div class="panel-resize-handle panel-resize-n"  onmousedown="startPanelResize(event,'n')"></div>
  <div class="panel-resize-handle panel-resize-e"  onmousedown="startPanelResize(event,'e')"></div>
  <div class="panel-resize-handle panel-resize-w"  onmousedown="startPanelResize(event,'w')"></div>
  <div class="panel-resize-handle panel-resize-s"  onmousedown="startPanelResize(event,'s')"></div>
  <div class="panel-resize-handle panel-resize-nw" onmousedown="startPanelResize(event,'nw')"></div>
  <div class="panel-resize-handle panel-resize-ne" onmousedown="startPanelResize(event,'ne')"></div>
  <div class="panel-resize-handle panel-resize-se" onmousedown="startPanelResize(event,'se')"></div>
  <div class="panel-resize-handle panel-resize-sw" onmousedown="startPanelResize(event,'sw')"></div>
  <div id="stat-titlebar">
    <span class="stat-panel-title">Stat Block Viewer</span>
    <div style="display:flex;gap:4px;">
      <button id="stat-minimize-btn" onclick="toggleStatMinimize()" title="Minimize">‚Äî</button>
      <button id="stat-close-btn" onclick="closeStatPanel()" title="Close">‚úï</button>
    </div>
  </div>
  <div id="stat-zoom-controls">
    <button class="btn-sm" onclick="adjustZoom(-0.25)">‚àí</button>
    <span class="zoom-label" id="zoom-display">100%</span>
    <button class="btn-sm" onclick="adjustZoom(0.25)">+</button>
    <button class="btn-sm" onclick="resetZoom()">Reset</button>
  </div>
  <div id="stat-preview">
    <div class="stat-preview-hint">Drop a stat block image or PDF anywhere</div>
  </div>
  <div id="stat-thumbs">
    <div class="drop-hint-strip">Drop files here</div>
  </div>
</div>
<script>
  // === POWERS LIBRARY (not persisted to localStorage) ===
  const POWERS_DATA = [
    // CHRONOPATHY (15)
    { id: 'glimpse', name: 'Glimpse', order: 1, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'bonus', concentration: true, duration: '1 round' },
    { id: 'time-thief', name: 'Time Thief', order: 1, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'again', name: 'Again', order: 2, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'reaction', concentration: false, duration: 'Instantaneous' },
    { id: 'intuition', name: 'Intuition', order: 2, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'precognition', name: 'Precognition', order: 2, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'read-object', name: 'Read Object', order: 2, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'forget', name: 'Forget', order: 3, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'ravages-of-time', name: 'Ravages of Time', order: 3, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'restore-the-past', name: 'Restore the Past', order: 3, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'memory-gap', name: 'Memory Gap', order: 4, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'stasis-field', name: 'Stasis Field', order: 4, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'reveal-the-path', name: 'Reveal the Path', order: 5, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'special', concentration: false, duration: 'Instantaneous' },
    { id: 'witness-demise', name: 'Witness Demise', order: 5, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: '1 minute' },
    { id: 'ally-of-time', name: 'Ally of Time', order: 6, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'rejuvenate', name: 'Rejuvenate', order: 6, school: 'Chronopathy', schoolKey: 'chr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    // METAMORPHOSIS (21)
    { id: 'minor-acceleration', name: 'Minor Acceleration', order: 1, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'bonus', concentration: false, duration: '1 round' },
    { id: 'sharpened-senses', name: 'Sharpened Senses', order: 1, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'bonus', concentration: false, duration: 'Instantaneous' },
    { id: 'adapt', name: 'Adapt', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: '24 hours' },
    { id: 'disappear', name: 'Disappear', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 round' },
    { id: 'flay', name: 'Flay', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'fluid-motion', name: 'Fluid Motion', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'fortify', name: 'Fortify', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'reaction', concentration: false, duration: '1 round' },
    { id: 'penetrating-sight', name: 'Penetrating Sight', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: '1 minute' },
    { id: 'sixth-sense', name: 'Sixth Sense', order: 2, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 hour' },
    { id: 'amplify', name: 'Amplify', order: 3, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'beam-gaze', name: 'Beam Gaze', order: 3, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'cure-ailment', name: 'Cure Ailment', order: 3, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'embrace-the-deep', name: 'Embrace the Deep', order: 3, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 hour' },
    { id: 'iron', name: 'Iron', order: 3, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'bonus', concentration: true, duration: '1 minute' },
    { id: 'psionic-resilience', name: 'Psionic Resilience', order: 4, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: '1 hour' },
    { id: 'shadow-form', name: 'Shadow Form', order: 4, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'bones-of-glass', name: 'Bones of Glass', order: 5, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'the-real', name: 'The Real', order: 5, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: '1 hour' },
    { id: 'brain-overload', name: 'Brain Overload', order: 6, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'paragon', name: 'Paragon', order: 6, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: false, duration: '8 hours' },
    { id: 'steel', name: 'Steel', order: 6, school: 'Metamorphosis', schoolKey: 'mtm', manifestTime: 'action', concentration: true, duration: '10 minutes' },
    // PYROKINESIS (15)
    { id: 'caress-of-fire', name: 'Caress of Fire', order: 1, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'flames-master', name: "Flame's Master", order: 1, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'incinerate', name: 'Incinerate', order: 1, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: false, duration: '1 round' },
    { id: 'ignite', name: 'Ignite', order: 2, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'kindling', name: 'Kindling', order: 2, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'scorch', name: 'Scorch', order: 2, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'imbue-flame', name: 'Imbue Flame', order: 3, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'overheat', name: 'Overheat', order: 3, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'smoke-screen', name: 'Smoke Screen', order: 3, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'fire-form', name: 'Fire Form', order: 4, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'melt', name: 'Melt', order: 4, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'detonate', name: 'Detonate', order: 5, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'heat-shell', name: 'Heat Shell', order: 5, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'crucible', name: 'Crucible', order: 6, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'heat-transfer', name: 'Heat Transfer', order: 6, school: 'Pyrokinesis', schoolKey: 'pyr', manifestTime: 'action', concentration: true, duration: '1 minute' },
    // RESOPATHY (17)
    { id: 'apparition', name: 'Apparition', order: 1, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'illuminator', name: 'Illuminator', order: 1, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: '1 hour' },
    { id: 'psionic-bolt', name: 'Psionic Bolt', order: 1, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'rewrite', name: 'Rewrite', order: 1, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '10 minutes' },
    { id: 'jaunt', name: 'Jaunt', order: 2, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'mindscape', name: 'Mindscape', order: 2, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: '1 round' },
    { id: 'weight', name: 'Weight', order: 2, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'elsewhere', name: 'Elsewhere', order: 3, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'extinguish', name: 'Extinguish', order: 3, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'guise', name: 'Guise', order: 3, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 hour' },
    { id: 'icon-of-fear', name: 'Icon of Fear', order: 3, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'momentary-lapse-of-reason', name: 'Momentary Lapse of Reason', order: 4, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'reminisce', name: 'Reminisce', order: 4, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'restructure', name: 'Restructure', order: 5, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'target-of-hate', name: 'Target of Hate', order: 5, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'fold-space', name: 'Fold Space', order: 6, school: 'Resopathy', schoolKey: 'res', manifestTime: 'special', concentration: false, duration: '1 round' },
    { id: 'reflection', name: 'Reflection', order: 6, school: 'Resopathy', schoolKey: 'res', manifestTime: 'action', concentration: true, duration: '1 minute' },
    // TELEKINESIS (15)
    { id: 'concussive-slam', name: 'Concussive Slam', order: 1, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'invisible-force', name: 'Invisible Force', order: 1, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'psionic-shift', name: 'Psionic Shift', order: 1, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'bonus', concentration: false, duration: 'Instantaneous' },
    { id: 'choke', name: 'Choke', order: 2, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'kinetic-crush', name: 'Kinetic Crush', order: 2, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: '1 round' },
    { id: 'repel', name: 'Repel', order: 2, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'capture-energy', name: 'Capture Energy', order: 3, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'reaction', concentration: false, duration: 'Instantaneous' },
    { id: 'pulse', name: 'Pulse', order: 3, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'telekinetic-burst', name: 'Telekinetic Burst', order: 3, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'fulcrum', name: 'Fulcrum', order: 4, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'gravitational-collapse', name: 'Gravitational Collapse', order: 4, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'chariot-of-thought', name: 'Chariot of Thought', order: 5, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: true, duration: '1 hour' },
    { id: 'force-orbs', name: 'Force Orbs', order: 5, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'concussive-wave', name: 'Concussive Wave', order: 6, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'mass-choke', name: 'Mass Choke', order: 6, school: 'Telekinesis', schoolKey: 'tlk', manifestTime: 'action', concentration: true, duration: '1 minute' },
    // TELEPATHY (20)
    { id: 'influence', name: 'Influence', order: 1, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'bonus', concentration: false, duration: 'Instantaneous' },
    { id: 'psychic-stab', name: 'Psychic Stab', order: 1, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'shared-thoughts', name: 'Shared Thoughts', order: 1, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: '1 round' },
    { id: 'awe', name: 'Awe', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'believe', name: 'Believe', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: '1 round' },
    { id: 'bolster-ego', name: 'Bolster Ego', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'reaction', concentration: false, duration: 'Instantaneous' },
    { id: 'make-friends', name: 'Make Friends', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: '1 hour' },
    { id: 'read-thoughts', name: 'Read Thoughts', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'share-pain', name: 'Share Pain', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'reaction', concentration: false, duration: 'Instantaneous' },
    { id: 'veritas', name: 'Veritas', order: 2, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '10 minutes' },
    { id: 'clarity', name: 'Clarity', order: 3, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'dagger-of-the-mind', name: 'Dagger of the Mind', order: 3, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'distant-voice', name: 'Distant Voice', order: 3, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'aura-projection', name: 'Aura Projection', order: 4, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'harlequin', name: 'Harlequin', order: 4, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'broadcast', name: 'Broadcast', order: 5, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: '1 minute' },
    { id: 'fracture', name: 'Fracture', order: 5, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: false, duration: 'Instantaneous' },
    { id: 'psychic-projection', name: 'Psychic Projection', order: 5, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'mindwipe', name: 'Mindwipe', order: 6, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 minute' },
    { id: 'souls-intertwined', name: 'Souls Intertwined', order: 6, school: 'Telepathy', schoolKey: 'tlp', manifestTime: 'action', concentration: true, duration: '1 hour' },
  ];

  // === POWER DESCRIPTIONS ===
  const POWER_DESCRIPTIONS = {
    'glimpse': `You glimpse the immediate future of one willing creature within 5 feet and impart a warning into their mind. The next attack roll made against the target before the end of your next turn has disadvantage.`,
    'time-thief': `You psionically absorb the life force of a creature within 30 feet, causing them to age faster than normal. The target makes a Constitution save; on a failure they take 1d4 necrotic damage and you gain temporary hit points equal to the damage taken.`,
    'again': `As a reaction when you or a creature within 30 feet misses with an attack, you momentarily rewind time, allowing that creature a second chance. The creature rerolls the attack and must use the new result.`,
    'intuition': `You target up to three willing creatures within 30 feet, gifting them precognitive insight. For up to 1 minute (Concentration), each time a target takes damage, the damage is reduced by 1d4 (minimum 0).`,
    'precognition': `You touch a willing creature and gift them limited foresight. For 8 hours, the target adds 1d6 to initiative rolls and cannot be surprised.`,
    'read-object': `You touch an object and receive a mental image of the last creature to hold it, and see and hear any events within 20 feet of the object in the last 8 hours from the object's perspective. Instantaneous.`,
    'forget': `You reach into the mind of a creature within 60 feet, making them forget critical knowledge (Constitution save). On a failure, for 1 minute the target either can't manifest powers of 4th order or lower, can't cast spells of 3rd level or higher, or loses weapon proficiencies (save ends at end of turn).`,
    'ravages-of-time': `You attempt to rapidly age the body of one creature within 60 feet (Constitution save). On a failure, the target takes 5d8 necrotic damage and ages 1d10 years; the aging reverts on a long rest.`,
    'restore-the-past': `You touch a piece of a destroyed Large or smaller mundane object (worth up to 1,000 gp) and remake it with your mind, even if pieces are missing or reduced to dust. Instantaneous.`,
    'memory-gap': `You attempt to erase another creature's memory within 30 feet (Wisdom save). On a failure, you permanently eliminate their memory of one event within the last 24 hours that lasted no more than 10 minutes; the creature is unbothered by the gap.`,
    'stasis-field': `You shape a translucent 20-foot cube originating from you. For 8 hours, objects inside the cube that aren't worn or carried cannot be moved, damaged, or destroyed; only you and creatures inside when it appears can pass freely through it.`,
    'reveal-the-path': `Over 10 minutes you name or describe a creature familiar to you that passed within 1,000 feet of your location in the last 24 hours, then instantly know every location it visited and the direction and distance to each. Instantaneous.`,
    'witness-demise': `You project a mental image into the minds of up to three creatures within 30 feet. Choose Future Demise (targets can't be frightened and have advantage on saves for 1 minute) or Imminent Demise (Wisdom save or 8d8 psychic damage and frightened for 1 minute, save ends at end of turn).`,
    'ally-of-time': `You alter time in a 40-foot cube within 120 feet (Concentration, up to 1 minute). When a creature starts their turn in the cube, you may Accelerate it (doubled speed, +2 AC, advantage on Dex saves, extra limited action) or Decelerate it (Wisdom save or halved speed, ‚àí2 AC, disadvantage on Dex saves, no reactions).`,
    'rejuvenate': `You touch one creature and reshape the flow of time through their body. They gain one of: regain 50 hit points, end one condition (blinded, charmed, dazed, deafened, frightened, paralyzed, petrified, poisoned, stunned), or regain one expended spell slot of level 1d4+1 or lower. Instantaneous.`,
    'minor-acceleration': `You touch a willing creature as a bonus action, increasing their speed by 10 feet until the end of your next turn. Instantaneous.`,
    'sharpened-senses': `As a bonus action, you make a Wisdom (Perception) check to detect hidden creatures, doors, objects, or traps in your surroundings, with advantage from psionic focus. Instantaneous.`,
    'adapt': `You choose up to four willing creatures within 15 feet. For 24 hours, each target can survive without food or water and is immune to exhaustion from mundane environmental or weather effects.`,
    'disappear': `You send psionic energy through a willing creature you touch, making them and everything they wear or carry invisible until the end of your next turn. Concentration, up to 1 round.`,
    'flay': `You shoot a 15-foot cone of pure psionic energy. Each creature in the area makes an Intelligence save, taking 2d6 psychic damage on a failure or half on a success. Instantaneous.`,
    'fluid-motion': `You imbue your body with psionic energy for up to 1 minute (Concentration). Choose one benefit: Dash as a bonus action, triple jump distance, or advantage on Athletics/Acrobatics checks to escape grapples and on saves against being grappled or restrained.`,
    'fortify': `As a reaction when you or a creature within 30 feet takes acid, cold, fire, force, lightning, or thunder damage, you create a barrier granting resistance to that damage type (including the triggering damage) until the end of your next turn.`,
    'penetrating-sight': `For 1 minute you can see into and through solid matter out to 30 feet. Vision penetrates 1 foot of stone, 1 inch of metal, or 3 feet of wood or dirt; lead blocks it.`,
    'sixth-sense': `You touch a willing creature and grant them one new sense for 1 hour: darkvision (60 ft), tremorsense (10 ft), or the ability to detect psionics within 30 feet.`,
    'amplify': `As a bonus action, you channel psionic power into a creature within 30 feet. The next time the target hits with a weapon attack within 1 minute, the attack deals an extra 2d8 psychic damage.`,
    'beam-gaze': `You unleash a beam of force at a creature within 120 feet (Constitution save). On a failure, they take 3d10 force damage and are poisoned, or have halved speed and no reactions, or attacks against them have advantage for 1 minute (save ends at end of turn).`,
    'cure-ailment': `You touch a creature and end either one disease or one condition affecting them (blinded, charmed, dazed, deafened, frightened, or poisoned). Instantaneous.`,
    'embrace-the-deep': `You choose up to five willing creatures within 30 feet. For 24 hours, they don't need to breathe and gain either a burrowing speed or swimming speed equal to their walking speed.`,
    'iron': `Your skin turns into hard, dark metal for up to 10 minutes (Concentration). You gain 15 temporary HP, +2 AC, and can make up to two psionic unarmed strikes (1d10 + manifestation modifier bludgeoning).`,
    'psionic-resilience': `You touch a willing creature and grant them immunity to one chosen condition for 1 hour. If they already have the condition, it is suppressed for the duration.`,
    'shadow-form': `You transform yourself into amorphous shadow for up to 10 minutes (Concentration). You gain a flying speed of 60 ft, resistance to mundane damage, advantage on Stealth checks, and can move through spaces as narrow as 1 inch.`,
    'bones-of-glass': `You attempt to psionically weaken a creature within 90 feet (Constitution save). On a failure, the target gains vulnerability to bludgeoning, force, piercing, and slashing damage for up to 1 minute (Concentration); on a success, it takes 3d10 psychic damage.`,
    'the-real': `A willing creature you touch gains truesight out to 120 feet, automatically notices psionic or magical secret doors, and can see into the Ethereal Plane for 1 hour.`,
    'brain-overload': `You unleash a surge of energy in the mind of a creature within 120 feet (Constitution save). On a failure, the target takes 14d10 psychic damage; if this reduces them to 0 HP and they have a brain, their brain explodes and they die instantly. Instantaneous.`,
    'paragon': `One willing creature you touch has each of their ability scores become 20 (unless already higher) for 8 hours.`,
    'steel': `Your skin turns into hard metal for up to 10 minutes (Concentration). You gain resistance to bludgeoning/piercing/slashing damage, critical hits become normal hits, you can make up to three psionic unarmed strikes (2d10 + modifier), and you regain 10 HP at the start of each turn.`,
    'caress-of-fire': `You touch a willing creature, wreathing them in psionic fire for up to 1 minute (Concentration). Any creature that touches the target or hits them with a melee attack for the first time on a turn takes 1d4 fire damage.`,
    'flames-master': `You emit a burst of psionic energy affecting every Medium or smaller fire-based light source within 30 feet, individually igniting or snuffing each. Supernatural sources are unaffected. Instantaneous.`,
    'incinerate': `A column of flame filling a 5-foot cube bursts from the ground at a point within 60 feet and burns until the end of your next turn. Any creature in it makes a Dexterity save or takes 1d6 fire damage; ignites unattended flammable objects.`,
    'ignite': `You ignite a creature within 60 feet (Dexterity save). On a failure, the target takes 2d6 fire damage and catches fire, taking 1d6 fire damage at the end of each turn until extinguished (target uses an action and repeats the save). Concentration, up to 1 minute.`,
    'kindling': `You psionically weaken a creature or object within 30 feet to fire (Constitution save for creatures). For up to 1 minute (Concentration), fire immunity becomes resistance, resistance is removed, or neither becomes vulnerability.`,
    'scorch': `A line of fire 30 feet long and 5 feet wide blasts from you. Each creature in the line makes a Dexterity save, taking 2d6 fire damage on a failure or half on a success; flammable objects ignite. Instantaneous.`,
    'imbue-flame': `You touch a willing creature and imbue them with fiery psionic force for up to 10 minutes (Concentration). Their weapon attacks and unarmed strikes deal an extra 1d6 fire damage.`,
    'overheat': `You attempt to raise the internal temperature of a creature within 30 feet (Constitution save). On a success they take 2d6 fire damage; on a failure they gain one level of exhaustion. Creatures resistant or immune to fire auto-succeed. Instantaneous.`,
    'smoke-screen': `You create a 20-foot-radius sphere of opaque smoke centered on a point within 90 feet (Concentration, up to 1 minute). The area is heavily obscured. Each creature entering or starting in the smoke makes a Constitution save, taking 3d6 fire damage on a failure or half on a success.`,
    'fire-form': `You encase yourself in psionic flame for up to 10 minutes (Concentration), gaining a flying speed of 60 ft, immunity to cold and fire, 1d6 fire damage to melee attackers, and extra 1d6 fire damage on your own attacks.`,
    'melt': `You cause a manufactured metal object (no larger than Medium) within 60 feet to glow red-hot. If unattended it melts; if carried, the bearer makes a Dexterity save, taking 5d10 fire damage on a failure (object melts) or half on a success. Instantaneous.`,
    'detonate': `You place an explosive psionic spark in a creature within 120 feet (Constitution save). On a failure, the spark is imbued (Concentration, up to 1 hour); you can use an action to detonate it, dealing 8d10 fire damage to the target and 8d10 to all creatures within 20 feet (Dexterity save for half).`,
    'heat-shell': `A shimmering globe of heat extends 10 feet from you for up to 1 hour (Concentration). Creatures touching the shell or starting inside it take 4d8 fire damage; the shell blocks physical passage but not spells or ranged attacks.`,
    'crucible': `You ignite a 50-foot-square area within 150 feet (Concentration, up to 1 minute). Each creature starting their turn inside makes a Dexterity save, taking 7d10 fire damage on a failure or half on a success. The fire spreads 5 feet per round.`,
    'heat-transfer': `You drain warmth from one non-Construct, non-Undead creature within 120 feet (Concentration, up to 1 minute). At the start of each of their turns they make a Constitution save, taking 4d10 cold damage on a failure or half on a success; you may grant half the cold damage as healing to another eligible creature within range.`,
    'apparition': `You create a sound or image that only you and one creature within 60 feet perceive. A sound can range from a whisper to a scream; an image must fit within a 5-foot cube and can't move or affect senses other than sight. Concentration, up to 1 minute.`,
    'illuminator': `You create a focused 30-foot cone of bright light from yourself for 1 hour, with sharp edges and no dim light. You can change its color and toggle it on or off at will (no action required).`,
    'psionic-bolt': `You shoot a purple beam of psychic force at a creature or object within 120 feet (ranged power attack). On a hit, the target takes 1d6 force damage and, if Large or smaller, is pushed 5 feet away from you. Instantaneous.`,
    'rewrite': `You bend reality to transform one Tiny mundane unattended object within 5 feet into another Tiny mundane object of equal or lesser value for up to 10 minutes (Concentration).`,
    'jaunt': `You teleport yourself or one willing creature you touch to an unoccupied space within 30 feet that you can see; the target need not see the destination. Instantaneous.`,
    'mindscape': `You alter a creature's perception of their environment within 30 feet (Wisdom save). On a success, the target takes 1d6 psychic damage; on a failure, they take the Dash action and move in a random direction. Duration 1 round.`,
    'weight': `You alter a creature's relationship with gravity within 30 feet (Constitution save). For up to 1 minute (Concentration), choose Gravitas (speed reduced by 20 ft) or Levitas (target rises 5 ft at the start of each of their turns; save ends at end of turn).`,
    'elsewhere': `You target three creatures within 30 feet (Intelligence save). On a failure, a target is teleported up to 30 feet to an unoccupied space you can see and their speed becomes 0 until the start of your next turn. Instantaneous.`,
    'extinguish': `Choose one creature, object, or psionic effect within 120 feet. Any power of 3rd order or lower on the target ends. Instantaneous.`,
    'guise': `You project a psionic appearance over your body, transforming your look into any creature of your size you have encountered for 1 hour. The disguise fails under physical inspection (Intelligence Investigation vs. your power save DC).`,
    'icon-of-fear': `Pick one creature within 120 feet. Each creature of your choice within 30 feet of that target sees them as something to fear and must make a Wisdom save or be frightened of them for up to 1 minute (Concentration; save ends at end of turn).`,
    'momentary-lapse-of-reason': `Choose one creature or object within 120 feet. Each creature of your choice within 30 feet sees it as something they greatly desire and must make a Wisdom save or drop what they hold and rush toward it, falling prone beside it. Instantaneous.`,
    'reminisce': `One creature within 30 feet makes a Wisdom save. On a failure, the target believes a friend or loved one has appeared and engages in imaginary conversation for up to 1 hour (Concentration), taking no actions; the effect ends if they take damage or are told the figure isn't real.`,
    'restructure': `You touch a Large or smaller mundane object and alter the material it is made of (metal to stone, wood to glass, etc.) without changing its state or increasing its value. Instantaneous.`,
    'target-of-hate': `Choose one creature within 120 feet. Each hostile creature within 30 feet of the target sees them as something they despise and must make a Wisdom save or use their reaction to move toward and attack the target. Instantaneous.`,
    'fold-space': `Over 10 minutes you create a one-way 10-foot-diameter portal in an unoccupied space within 30 feet that transports any creature passing through it to a destination on any plane of existence you know. The portal lasts until the end of your next turn.`,
    'reflection': `You psionically create a perfect copy of one creature within 60 feet (CR 10 or lower). Concentration, up to 1 minute. The copy appears in range, acts after your turn on your initiative, shares the original's current statistics and resources, and is loyal to you via a mental link.`,
    'concussive-slam': `You slam invisible force down upon a creature within 30 feet (Strength save). On a failed save, the target takes 1d4 force damage and is knocked prone. Instantaneous.`,
    'invisible-force': `Choose one: manipulate one object with movable parts within 30 feet, move an object (5 lbs or less) up to 30 feet, or hurl a 5-pound object at a creature (ranged power attack, 1d8 damage on a hit). Instantaneous.`,
    'psionic-shift': `As a bonus action, choose one non-grappled creature other than you within 15 feet (Strength save). On a failure, the target is moved 5 feet in a direction of your choice; the target may choose to fail. Instantaneous.`,
    'choke': `You attempt to crush a Large or smaller creature within 30 feet in your telekinetic grip (Dexterity save). On a failure, the target is restrained (Concentration, up to 1 minute) and takes 1d6 force damage at the start of each turn.`,
    'kinetic-crush': `One creature within 60 feet is held in your telekinetic grip (Strength save). On a failure, the target takes 2d8 force damage and their speed becomes 0 until the start of your next turn. On a success, half damage and no speed loss.`,
    'repel': `You telekinetically force a Medium or smaller creature or object (300 lbs or less) within 30 feet away from you (Strength save for creatures). On a failure, the target moves up to 30 feet in any direction; on a success, 5 feet. Objects automatically fail. Instantaneous.`,
    'capture-energy': `As a reaction to taking acid, cold, fire, force, lightning, or thunder damage, you capture some of it, taking only half damage. You can then hurl the captured energy at a creature or object within 30 feet (ranged power attack), dealing the remaining damage on a hit. Instantaneous.`,
    'pulse': `Waves of force emanate from you in a 15-foot radius for up to 10 minutes (Concentration). Creatures of your choice treat the area as difficult terrain, and whenever a creature ends their turn within 15 feet of you, you can attempt to trip them (Strength save or fall prone, no action required).`,
    'telekinetic-burst': `You unleash an explosion of mental force from a point within 90 feet. Each creature in a 20-foot-radius sphere makes a Dexterity save, taking 5d6 force damage and being pushed 10 feet on a failure, or half damage and no push on a success. Instantaneous.`,
    'fulcrum': `You exert your will to control one Huge or smaller creature or object within 60 feet (Concentration, up to 10 minutes). On each of your turns you can move the target up to 30 feet in any direction (Strength save for creatures; failure leaves them restrained and suspended in midair).`,
    'gravitational-collapse': `You bring crushing force down on a creature within 90 feet (Dexterity save). On a failure, the target takes 10d6 force damage and is knocked prone (Concentration, up to 1 minute); they can use an action to make a Strength check to stand and end the effect.`,
    'chariot-of-thought': `A 10-foot-radius disk of psionic force springs up beneath your feet, granting you a flying speed of 60 feet for up to 10 minutes (Concentration). The disk carries up to nine Medium creatures and passes harmlessly through creatures and objects.`,
    'force-orbs': `You create three orbs of swirling energy that orbit you for 10 minutes, each granting +1 AC. As a bonus action, you can hurl one orb at a target within 60 feet (ranged power attack, 4d10 force damage on a hit); the orb disappears after use.`,
    'concussive-wave': `You send forth a rising telekinetic shockwave. Each creature of your choice within 30 feet makes a Strength save or is thrown up to 90 feet vertically and 30 feet away from you, then slammed to the ground taking 1d6 bludgeoning per 10 feet fallen and landing prone. Instantaneous.`,
    'mass-choke': `You lock enemies in your telekinetic grip. Each creature of your choice within 30 feet makes a Dexterity save or is restrained (Concentration, up to 1 minute), taking 5d8 force damage at the start of each of their turns. Ends if any target leaves range or has total cover from you.`,
    'influence': `As a bonus action, you make a Charisma check (with advantage from psionic touch) to influence or entertain a creature within 30 feet. On a failure, the creature realizes you used psionics and becomes hostile. Creatures that can't be charmed are immune. Instantaneous.`,
    'psychic-stab': `One creature within 120 feet makes an Intelligence save, taking 1d10 psychic damage on a failed save. Instantaneous.`,
    'shared-thoughts': `You send a telepathic message of up to 25 words (or a single image) to a creature within 30 feet you are aware of. The target can reply with up to 25 words before the start of your next turn. Messages pass through most solid barriers.`,
    'awe': `You project psionic emotional energy onto one creature within 30 feet (Concentration, up to 1 minute). Choose Inspiring (target gains temporary HP equal to your manifestation modifier at start of their turns) or Terrifying (Wisdom save or frightened of you, save ends at end of turn).`,
    'believe': `One creature within 60 feet makes a Wisdom save or gains a new belief until the end of their next turn: Chasm (falls prone, can't stand), Disaster (Dashes randomly), Enemies (attacks nearest ally), or Friends (incapacitated).`,
    'bolster-ego': `As a reaction when you or a creature within 30 feet makes a saving throw, you psionically bolster them, granting advantage on that save. Instantaneous.`,
    'make-friends': `You attempt to charm a Humanoid within 30 feet (Wisdom save, advantage if in combat). On a failure, the target is charmed by you for 1 hour, regarding you as a friendly acquaintance. When the effect ends, the creature knows they were charmed.`,
    'read-thoughts': `You choose a creature within 60 feet and learn their surface thoughts for up to 1 minute (Concentration). You have advantage on Insight and Charisma checks against them. Creatures with Intelligence 3 or lower or no language are immune.`,
    'share-pain': `As a reaction to being damaged by a creature within 60 feet, you reach out psionically. The creature makes a Wisdom save, taking 1d12 psychic damage on a failure or half on a success. Instantaneous.`,
    'veritas': `You target up to three creatures within 60 feet (Charisma save). On a failure, you know when each creature speaks or communicates a lie for 10 minutes.`,
    'clarity': `You touch one creature, helping them enter a state of intense focus. For up to 1 minute (Concentration), the target has advantage on ability checks and attack rolls.`,
    'dagger-of-the-mind': `One creature within 60 feet makes an Intelligence save. On a failure, the target takes 4d10 psychic damage and can only Dash, Disengage, or Dodge on their next turn; on a success, half damage and no restriction.`,
    'distant-voice': `You send a message of 25 words or fewer to a familiar creature at any distance or across planes. The creature hears you in their mind, recognizes you, and can reply immediately. Duration 1 round.`,
    'aura-projection': `You manifest a psionic emotional aura in a 30-foot radius (Concentration, up to 1 minute). At the start of your turn, choose one creature within range and apply: Inspired (advantage on attacks and saves), Sorrow (Wisdom save or next action spent weeping), or Terror (Wisdom save or frightened until your next turn).`,
    'harlequin': `You psionically grasp for control of one Humanoid within 120 feet (Wisdom save, advantage if in combat). On a failure, the target is charmed (Concentration, up to 1 hour) and you have a telepathic link; you can issue commands and use your action for total control. Charm ends if they succeed on a new save after taking damage.`,
    'broadcast': `Over 1 minute, you broadcast a telepathic message to every creature of your choice that can understand a language within up to 1 mile, including personal images. The message lasts 1 minute. Instantaneous.`,
    'fracture': `You unleash a burst of psionic power at a point within 90 feet. Each creature in a 20-foot-radius sphere makes an Intelligence save. On a failure, they take 6d8 psychic damage and are fractured for 1 minute (halved speed, disadvantage on checks/attacks/saves; save ends at end of turn). Instantaneous.`,
    'psychic-projection': `Over 10 minutes you project your consciousness to a known location on the same plane for up to 1 hour (Concentration). Your body is left unconscious. Your projection shares your statistics but can't affect the world physically or manifest powers; it has immunity to all damage except force and psychic.`,
    'mindwipe': `You attempt to wipe the mind of a creature within 60 feet (Wisdom save). On a success, the target takes 3d10 psychic damage. On a failure, their proficiency bonus becomes +0 and they can't cast spells, manifest powers, understand language, or communicate intelligibly (Concentration, up to 1 minute).`,
    'souls-intertwined': `You attempt to swap the minds of two creatures within 60 feet (Charisma save each). If both fail, their minds swap (Concentration, up to 1 hour), each using the other's INT/WIS/CHA scores and memories. If one dies while swapped, their soul may move on or contest to reclaim its original body.`,
  };

  // === STATE ===
  const DEFAULTS = {
    characterName: 'Character',
    hp: { current: 100, max: 100, temp: 0 },
    hitDice: { max: 0, current: 0, dieType: 'd8', open: false },
    activeSpells: [],
    strain: { body: 0, mind: 0, soul: 0 },
    strainMax: 16,
    manifestDie: 'd6',
    knownPowers: [],
    concentration: [],
    strainOpen: true,
    powersOpen: true,
    conditions: [],
    immunities: [],
    resistances: [],
    immResOpen: false,
    layout: { leftW: 260, rightW: 360 },
    stats: {
      ac: 15,
      str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10,
      savStr: 0, savDex: 0, savCon: 0, savInt: 0, savWis: 0, savCha: 0,
      passPerc: 10,
      levelLabel: '1 Fighter',
      initiative: 0,
      speed: 30,
      speedSwim: 0, speedClimb: 0, speedFly: 0
    },
    profBonus: 2,
    senses: { truesight: 0, blindsight: 0, tremorsense: 0 },
    sensesOpen: false,
    charOpen: true,
    statsOpen: true,
    scoresOpen: true,
    savesOpen: true,
    attacks: [],
    items: [],
    inventoryOpen: false,
    attunementMax: 3,
    currency: { pp: 0, gp: 0, sp: 0, cp: 0 },
    statusOpen: true,
    spellsOpen: true,
    feats: [],
    featsOpen: true,
    loreBook: [],
    loreActiveId: null,
    saveProfs: { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 },
    hpEffects: {
      aid:            { active: false, value: 5 },
      heroesFeast:    { active: false, value: 0 },
      maxHpReduction: { active: false, value: 0 },
    },
    skillsOpen: true,
    skills: {
      athletics: 0,
      acrobatics: 0, sleightOfHand: 0, stealth: 0,
      arcana: 0, history: 0, investigation: 0, nature: 0, religion: 0,
      animalHandling: 0, insight: 0, medicine: 0, perception: 0, survival: 0,
      deception: 0, intimidation: 0, performance: 0, persuasion: 0,
    },
    customSkills: [],
    skillBonuses: {},
  };

  const STORAGE_KEY = 'talent_companion_v1';

  function loadState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULTS));
    } catch { return JSON.parse(JSON.stringify(DEFAULTS)); }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();
  let diceHistory = [];   // max 5 entries: { expr, total, detail }
  let diceModifier = 0;
  let diceCount = 1;
  let diceMenuOpen = false;
  let srDiceToSpend = 1;
  let srRolls = [];        // array of { roll, conMod, total }
  let srPhase = 'pick';    // 'pick' | 'rolled'
  // Migrate older saved states that lack newer fields
  if (!state.hitDice) state.hitDice = { max: 0, current: 0, dieType: 'd8', open: false };
  if (state.hitDice.open === undefined) state.hitDice.open = false;
  if (!state.stats) state.stats = { ...DEFAULTS.stats };
  if (!state.immunities) state.immunities = [];
  if (!state.resistances) state.resistances = [];
  if (state.immResOpen === undefined) state.immResOpen = false;
  if (!state.activeSpells) state.activeSpells = [];
  if (!state.conditions) state.conditions = [];
  if (!state.layout) state.layout = { leftW: 260, rightW: 300 };
  if (state.stats.levelLabel === undefined) state.stats.levelLabel = '1 Fighter';
  if (state.stats.initiative === undefined) state.stats.initiative = 0;
  if (state.stats.speed === undefined) state.stats.speed = 30;
  if (state.profBonus === undefined) state.profBonus = 2;
  if (!state.senses) state.senses = { truesight: 0, blindsight: 0, tremorsense: 0 };
  if (state.sensesOpen === undefined) state.sensesOpen = false;
  if (!state.attacks) state.attacks = [];
  // Migrate from old inventory/magicItems to unified items
  if (state.items === undefined) {
    state.items = [
      ...(state.inventory || []).map(i => ({
        ...i,
        type: 'normal',
        equipped: false,
        attuned: false,
        description: i.description ?? ''
      })),
      ...(state.magicItems || []).map(i => ({
        ...i,
        type: 'magic',
        description: i.description ?? ''
      }))
    ];
    delete state.inventory;
    delete state.magicItems;
  }
  if (!state.items) state.items = [];
  if (state.inventoryOpen === undefined) state.inventoryOpen = false;
  if (state.attunementMax === undefined) state.attunementMax = 3;
  state.items.forEach(i => {
    if (i.description === undefined) i.description = '';
    if (i.qty === undefined) i.qty = '1';
    if (i.type === undefined) i.type = 'normal';
    if (i.equipped === undefined) i.equipped = false;
    if (i.attuned === undefined) i.attuned = false;
    if (i.chargeMax === undefined) i.chargeMax = 0;
    if (i.chargeCurrent === undefined) i.chargeCurrent = 0;
  });
  if (state.characterName === undefined) state.characterName = 'Character';
  if (state.statusOpen === undefined) state.statusOpen = true;
  if (!state.feats) state.feats = [];
  if (state.featsOpen === undefined) state.featsOpen = true;
  state.feats.forEach(f => {
    if (f.description === undefined) f.description = '';
  });
  if (state.layout.rightW < 340) state.layout.rightW = 360;
  if (!state.saveProfs) state.saveProfs = { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 };
  if (state.charOpen   === undefined) state.charOpen   = true;
  if (state.statsOpen  === undefined) state.statsOpen  = true;
  if (state.scoresOpen === undefined) state.scoresOpen = true;
  if (state.savesOpen  === undefined) state.savesOpen  = true;
  if (state.skillsOpen === undefined) state.skillsOpen = true;
  if (!state.skills) state.skills = { ...DEFAULTS.skills };
  if (!state.customSkills) state.customSkills = [];
  if (!state.skillBonuses) state.skillBonuses = {};
  if (!state.currency) state.currency = { pp: 0, gp: 0, sp: 0, cp: 0 };
  if (!state.hpEffects) state.hpEffects = JSON.parse(JSON.stringify(DEFAULTS.hpEffects));
  if (state.stats.speedSwim === undefined) state.stats.speedSwim = 0;
  if (state.stats.speedClimb === undefined) state.stats.speedClimb = 0;
  if (state.stats.speedFly === undefined) state.stats.speedFly = 0;
  ['savStr','savDex','savCon','savInt','savWis','savCha'].forEach(k => { if (state.stats[k] === undefined) state.stats[k] = 0; });
  if (!state.loreBook) state.loreBook = [];
  if (state.loreActiveId === undefined) state.loreActiveId = null;
  if (!state.strain) state.strain = { body: 0, mind: 0, soul: 0 };
  if (state.strainMax === undefined) state.strainMax = 16;
  if (!state.manifestDie) state.manifestDie = 'd6';
  if (!state.knownPowers) state.knownPowers = [];
  if (!state.concentration) state.concentration = [];
  if (state.strainOpen === undefined) state.strainOpen = true;
  if (state.powersOpen === undefined) state.powersOpen = true;
  if (state.spellsOpen === undefined) state.spellsOpen = true;
  function update(mutatorFn) {
    mutatorFn(state);
    saveState();
    render();
  }

  // === SECTION EDIT MODE ===
  let editSection = null;
  let speedExpanded = false;
  let itemDescOpen = {};
  let itemDescEdit = null; // id of item currently being edited
  let helpOpen = false;

  function sectionTitle(label, key, toggleFn, isOpen) {
    if (!key) return `<div class="panel-title">${label}</div>`;
    const editing = editSection === key;
    const chevron = toggleFn
      ? `<button class="btn-sm" onclick="event.stopPropagation();${toggleFn}()" style="padding:0 6px;">${isOpen ? '‚ñ≤' : '‚ñº'}</button>`
      : '';
    const titleOnClick = toggleFn ? `onclick="${toggleFn}()"` : '';
    return `
      <div class="panel-title" ${titleOnClick} style="display:flex;align-items:center;justify-content:space-between;${toggleFn ? 'cursor:pointer;' : ''}">
        <span>${label}</span>
        ${editing
          ? `<span class="section-edit-controls">
               <button class="edit-save-btn" onclick="saveSection('${key}')">Save</button>
               <button class="edit-cancel-btn" onclick="setEditSection(null)">‚úï</button>
             </span>`
          : `<span style="display:flex;gap:4px;align-items:center;">
               <button class="edit-pencil-btn" onclick="event.stopPropagation();setEditSection('${key}')" title="Edit">‚úè</button>
               ${chevron}
             </span>`
        }
      </div>`;
  }

  function setEditSection(key) {
    editSection = key;
    const expandMap = { hp: 'charOpen', combat: 'statsOpen', scores: 'scoresOpen', saves: 'savesOpen' };
    if (key && expandMap[key] && !state[expandMap[key]]) { state[expandMap[key]] = true; saveState(); }
    if (key === 'senses' && !state.sensesOpen) { state.sensesOpen = true; saveState(); }
    render();
  }
  function toggleSpeedExpand() { speedExpanded = !speedExpanded; renderHP(); }

  function saveSection(key) {
    const g = id => document.getElementById(id)?.value;
    const vals = {};
    if (key === 'hp') {
      vals.current = g('edit-hp-current');
      vals.max     = g('edit-hp-max');
      vals.temp    = g('edit-hp-temp');
    } else if (key === 'combat') {
      ['ac','initiative','speed','speedSwim','speedClimb','speedFly'].forEach(k => vals[k] = g('edit-' + k));
      vals.profBonus = g('edit-profbonus');
      vals.passPerc = g('edit-passperc');
    } else if (key === 'scores') {
      ['str','dex','con','int','wis','cha'].forEach(k => vals[k] = g('edit-' + k));
    } else if (key === 'saves') {
      ['savStr','savDex','savCon','savInt','savWis','savCha'].forEach(k => vals[k] = g('edit-' + k));
    } else if (key === 'senses') {
      ['truesight','blindsight','tremorsense'].forEach(k => vals[k] = g('edit-' + k));
    }
    editSection = null;  // clear before render() fires inside update()
    update(s => {
      if (key === 'hp') {
        const max = +vals.max;
        if (!isNaN(max) && max >= 1)     s.hp.max     = max;
        if (!isNaN(+vals.current))       s.hp.current = Math.max(0, Math.min(s.hp.max, +vals.current));
        if (!isNaN(+vals.temp))          s.hp.temp    = Math.max(0, +vals.temp);
      } else if (key === 'combat') {
        if (!isNaN(+vals.ac))         s.stats.ac         = +vals.ac;
        if (!isNaN(+vals.initiative))  s.stats.initiative  = +vals.initiative;
        if (!isNaN(+vals.speed))       s.stats.speed       = +vals.speed;
        if (!isNaN(+vals.speedSwim))   s.stats.speedSwim   = Math.max(0, +vals.speedSwim);
        if (!isNaN(+vals.speedClimb))  s.stats.speedClimb  = Math.max(0, +vals.speedClimb);
        if (!isNaN(+vals.speedFly))    s.stats.speedFly    = Math.max(0, +vals.speedFly);
        if (!isNaN(+vals.profBonus))  s.profBonus = +vals.profBonus;
        if (!isNaN(+vals.passPerc))   s.stats.passPerc    = +vals.passPerc;
      } else if (key === 'scores') {
        ['str','dex','con','int','wis','cha'].forEach(k => {
          if (!isNaN(+vals[k])) s.stats[k] = Math.max(1, Math.min(30, +vals[k]));
        });
      } else if (key === 'saves') {
        ['savStr','savDex','savCon','savInt','savWis','savCha'].forEach(k => {
          if (!isNaN(+vals[k])) s.stats[k] = +vals[k];
        });
      } else if (key === 'senses') {
        ['truesight','blindsight','tremorsense'].forEach(k => {
          if (!isNaN(+vals[k])) s.senses[k] = Math.max(0, +vals[k]);
        });
      }
    });
  }

  // === HP PANEL ===
  function renderHP() {
    const el = document.getElementById('panel-character');
    const { hp } = state;
    const st = state.stats;
    const basePct = Math.max(0, Math.min(100, (hp.current / hp.max) * 100));
    const hpCls = basePct > 50 ? 'hp-healthy' : basePct > 25 ? 'hp-hurt' : 'hp-critical';

    const isHP     = editSection === 'hp';
    const isStats  = editSection === 'combat';
    const isScores = editSection === 'scores';
    const isSaves  = editSection === 'saves';

    el.innerHTML = `
      ${sectionTitle('Character', 'hp', 'toggleCharOpen', state.charOpen)}

      ${state.charOpen ? `
      <div class="hp-section">
        <div class="hp-label">HP</div>
        <div class="hp-bar-track"><div class="hp-bar-fill ${hpCls}" style="width:${basePct}%"></div></div>
        ${isHP ? `
          <div class="stat-row"><span class="stat-label">Current HP</span><input class="edit-input-sm" id="edit-hp-current" type="number" min="0" value="${hp.current}"></div>
          <div class="stat-row"><span class="stat-label">Max HP</span><input class="edit-input-sm" id="edit-hp-max" type="number" min="1" value="${hp.max}"></div>
          <div class="stat-row"><span class="stat-label">Temp HP</span><input class="edit-input-sm" id="edit-hp-temp" type="number" min="0" value="${hp.temp}"></div>
        ` : `
          <div class="hp-controls">
            <span class="hp-display">${hp.current} / ${hp.max}</span>
            <button class="btn-sm" onclick="adjustHP(-1)">‚àí</button>
            <button class="btn-sm" onclick="adjustHP(1)">+</button>
            <button class="btn-sm" onclick="promptHP()">Set</button>
          </div>
          <div class="temp-hp">Temp HP: <strong>${hp.temp}</strong>
            <button class="btn-sm" onclick="adjustTemp(-1)">‚àí</button>
            <button class="btn-sm" onclick="adjustTemp(1)">+</button>
            <button class="btn-sm" onclick="promptTemp()">Set</button>
          </div>
        `}
      </div>` : ''}

      ${state.charOpen ? `<div style="margin-top:4px;padding:2px 0;">
        <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:3px 0;" onclick="toggleHitDice()">
          <span style="font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:#4a7a8a;">Hit Dice</span>
          <span style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:0.7rem;color:#5a8a9a;">${state.hitDice.current}/${state.hitDice.max} ${state.hitDice.dieType}</span>
            <span style="font-size:0.65rem;color:#3a6a7a;">${state.hitDice.open ? '‚ñ≤' : '‚ñº'}</span>
          </span>
        </div>
        ${state.hitDice.open ? `
          <div style="padding:4px 0 2px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
              <span style="font-size:0.72rem;color:#5a8a9a;">Max</span>
              <input type="number" min="0" max="30" value="${state.hitDice.max}"
                onchange="setHitDiceMax(this.value)"
                style="width:36px;background:#0f2535;border:1px solid #1a3a4a;color:#8ab8c8;padding:2px 4px;border-radius:3px;font-size:0.72rem;text-align:center;">
              <select onchange="setHitDieType(this.value)"
                style="background:#0f2535;border:1px solid #1a3a4a;color:#8ab8c8;padding:2px 4px;border-radius:3px;font-size:0.72rem;">
                ${['d6','d8','d10','d12'].map(d => `<option value="${d}" ${state.hitDice.dieType === d ? 'selected' : ''}>${d}</option>`).join('')}
              </select>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:2px;">
              ${state.hitDice.max === 0
                ? '<span style="font-size:0.72rem;color:#2a4a5a;">Set a max to track hit dice</span>'
                : Array.from({length: state.hitDice.max}, (_, idx) => `
                    <span onclick="clickHitDie(${idx})"
                      title="${idx < state.hitDice.current ? 'Click to spend' : 'Click to restore'}"
                      style="cursor:pointer;font-size:1.1rem;line-height:1;color:${idx < state.hitDice.current ? '#e05070' : '#2a4a5a'};">
                      ${idx < state.hitDice.current ? '‚ô•' : '‚ô°'}
                    </span>
                  `).join('')
              }
            </div>
          </div>
        ` : ''}
      </div>` : ''}

      <hr class="divider">
      ${sectionTitle('Stats', 'combat', 'toggleStatsOpen', state.statsOpen)}
      ${state.statsOpen ? isStats ? `
        <div class="stat-row"><span class="stat-label">AC</span><input class="edit-input-sm" id="edit-ac" type="number" value="${st.ac}"></div>
        <div class="stat-row"><span class="stat-label">Initiative</span><input class="edit-input-sm" id="edit-initiative" type="number" value="${st.initiative}"></div>
        <div class="stat-row"><span class="stat-label">Walk ft.</span><input class="edit-input-sm" id="edit-speed" type="number" value="${st.speed}"></div>
        <div class="stat-row"><span class="stat-label">Swim ft.</span><input class="edit-input-sm" id="edit-speedSwim" type="number" value="${st.speedSwim}"></div>
        <div class="stat-row"><span class="stat-label">Climb ft.</span><input class="edit-input-sm" id="edit-speedClimb" type="number" value="${st.speedClimb}"></div>
        <div class="stat-row"><span class="stat-label">Fly ft.</span><input class="edit-input-sm" id="edit-speedFly" type="number" value="${st.speedFly}"></div>
        <div class="stat-row"><span class="stat-label">Proficiency</span><input class="edit-input-sm" id="edit-profbonus" type="number" value="${state.profBonus}"></div>
        <div class="stat-row"><span class="stat-label">Pass. Percep.</span><input class="edit-input-sm" id="edit-passperc" type="number" value="${st.passPerc}"></div>
      ` : `
        <div class="stat-row"><span class="stat-label">AC</span><span class="stat-value editable-stat" onclick="editStat('ac')" title="Click to edit">${st.ac}</span></div>
        <div class="stat-row"><span class="stat-label">Initiative</span><span class="stat-value editable-stat" onclick="editStat('initiative')" title="Click to edit">+${st.initiative}</span></div>
        <div class="stat-row">
          <span class="stat-label">Speed
            <button class="btn-sm" onclick="toggleSpeedExpand()" title="${speedExpanded ? 'Collapse' : 'Expand'} speeds" style="font-size:0.6rem;padding:0 4px;margin-left:4px;">${speedExpanded ? '‚ñ≤' : '‚ñ∂'}</button>
          </span>
          <span class="stat-value editable-stat" onclick="editStat('speed')" title="Click to edit">${st.speed} ft.</span>
        </div>
        ${speedExpanded ? `
          <div class="stat-row" style="padding-left:12px;font-size:0.8rem;">
            <span class="stat-label" style="color:#5a8a9a;">Swim</span><span class="stat-value editable-stat" onclick="editStat('speedSwim')" title="Click to edit">${st.speedSwim} ft.</span>
          </div>
          <div class="stat-row" style="padding-left:12px;font-size:0.8rem;">
            <span class="stat-label" style="color:#5a8a9a;">Climb</span><span class="stat-value editable-stat" onclick="editStat('speedClimb')" title="Click to edit">${st.speedClimb} ft.</span>
          </div>
          <div class="stat-row" style="padding-left:12px;font-size:0.8rem;">
            <span class="stat-label" style="color:#5a8a9a;">Fly</span><span class="stat-value editable-stat" onclick="editStat('speedFly')" title="Click to edit">${st.speedFly} ft.</span>
          </div>
        ` : ''}
        <div class="stat-row"><span class="stat-label">Proficiency</span><span class="stat-value editable-stat" onclick="editProfBonus()" title="Click to edit">+${state.profBonus}</span></div>
        <div class="stat-row"><span class="stat-label">Pass. Percep.</span><span class="stat-value editable-stat" onclick="editStat('passPerc')" title="Click to edit">${st.passPerc}</span></div>
      ` : ''}

      <hr class="divider">
      ${sectionTitle('Ability Scores', 'scores', 'toggleScoresOpen', state.scoresOpen)}
      ${state.scoresOpen ? `<div class="saves-grid">
        ${[['STR','str'],['DEX','dex'],['CON','con'],['INT','int'],['WIS','wis'],['CHA','cha']].map(([name, key]) => {
          const score = st[key];
          const mod = Math.floor((score - 10) / 2);
          const sign = mod >= 0 ? '+' : '';
          return isScores
            ? `<div class="save-row"><span class="save-name">${name}</span><input class="edit-input-sm" id="edit-${key}" type="number" min="1" max="30" value="${score}"></div>`
            : `<div class="save-row"><span class="save-name">${name}</span><span class="save-val editable-stat" onclick="editStat('${key}')" title="Click to edit">${score} <span style="color:#5a8a9a;font-weight:400">(${sign}${mod})</span></span></div>`;
        }).join('')}
      </div>` : ''}

      <hr class="divider">
      ${sectionTitle('Saves', 'saves', 'toggleSavesOpen', state.savesOpen)}
      ${state.savesOpen ? `<div class="saves-grid">
        ${[['STR','str'],['DEX','dex'],['CON','con'],['INT','int'],['WIS','wis'],['CHA','cha']].map(([name, abKey]) => {
          const savKey = 'sav' + abKey.charAt(0).toUpperCase() + abKey.slice(1);
          const pipState = state.saveProfs[abKey];
          const pipCls = pipState === 2 ? 'expertise' : pipState === 1 ? 'prof' : '';
          const pipTitle = ['Not proficient', 'Proficient', 'Expertise'][pipState];
          const abilityMod = Math.floor(((state.stats[abKey] ?? 10) - 10) / 2);
          const profBonus = pipState === 2 ? state.profBonus * 2 : pipState === 1 ? state.profBonus : 0;
          const flatBonus = state.stats[savKey] ?? 0;
          const total = abilityMod + profBonus + flatBonus;
          const sign = total >= 0 ? '+' : '';
          if (isSaves) {
            return `<div class="save-row">
                <span class="save-name">${name}</span>
                <input class="edit-input-sm" id="edit-${savKey}" type="number" value="${flatBonus}" style="width:52px;" title="Flat bonus (on top of mod + prof)">
              </div>`;
          }
          return `<div class="save-row">
              <span style="display:flex;align-items:center;gap:4px;">
                <span class="prof-pip ${pipCls}" onclick="cycleSaveProf('${abKey}')" title="${pipTitle}"></span>
                <span class="save-name">${name}</span>
              </span>
              <span class="save-val">${sign}${total}${flatBonus !== 0 ? `<span style="font-size:0.65rem;color:#c8904a;margin-left:2px;">${flatBonus >= 0 ? '+' : ''}${flatBonus}</span>` : ''}</span>
            </div>`;
        }).join('')}
      </div>` : ''}

      ${renderSenses()}

      <hr class="divider">
      ${renderImmRes()}
    `;
  }

  function toggleCharOpen()    { update(s => s.charOpen    = !s.charOpen); }
  function toggleStatsOpen()   { update(s => s.statsOpen   = !s.statsOpen); }
  function toggleScoresOpen()  { update(s => s.scoresOpen  = !s.scoresOpen); }
  function toggleSavesOpen()   { update(s => s.savesOpen   = !s.savesOpen); }
  function toggleStrainOpen()  { update(s => s.strainOpen  = !s.strainOpen); }
  function togglePowersOpen()  { update(s => s.powersOpen  = !s.powersOpen); }
  function toggleHitDice() {
    update(s => s.hitDice.open = !s.hitDice.open);
  }
  function clickHitDie(idx) {
    update(s => {
      s.hitDice.current = s.hitDice.current > idx ? idx : idx + 1;
    });
  }
  function setHitDiceMax(val) {
    const max = Math.max(0, parseInt(val) || 0);
    update(s => {
      s.hitDice.max = max;
      s.hitDice.current = Math.min(s.hitDice.current, max);
    });
  }
  function setHitDieType(val) {
    update(s => s.hitDice.dieType = val);
  }
  function adjustHP(delta) {
    update(s => s.hp.current = Math.max(0, Math.min(s.hp.max, s.hp.current + delta)));
  }
  function adjustTemp(delta) {
    update(s => s.hp.temp = Math.max(0, s.hp.temp + delta));
  }
  function promptTemp() {
    const val = prompt('Set Temp HP:', state.hp.temp);
    if (val !== null && !isNaN(+val)) update(s => s.hp.temp = Math.max(0, +val));
  }
  function promptHP() {
    const val = prompt('Set current HP:', state.hp.current);
    if (val !== null && !isNaN(+val)) update(s => s.hp.current = Math.max(0, Math.min(s.hp.max, +val)));
  }

  function editProfBonus() {
    const val = prompt('Proficiency Bonus:', state.profBonus);
    if (val !== null && !isNaN(+val)) update(s => { s.profBonus = +val; });
  }
  function getPowerAtk() {
    const intMod = Math.floor(((state.stats.int ?? 10) - 10) / 2);
    return (state.profBonus ?? 2) + intMod;
  }
  function getPowerSaveDC() {
    return 8 + getPowerAtk();
  }
  function editStrainMax() {
    const val = prompt('Strain Maximum (typically 16):', state.strainMax);
    if (val !== null && !isNaN(+val) && +val >= 1) update(s => { s.strainMax = +val; });
  }
  function editManifestDie() {
    const val = prompt('Manifestation Die (d4 / d6 / d8):', state.manifestDie);
    if (val !== null && ['d4','d6','d8'].includes(val.trim().toLowerCase())) {
      update(s => { s.manifestDie = val.trim().toLowerCase(); });
    }
  }
  function cycleSaveProf(key) {
    update(s => s.saveProfs[key] = (s.saveProfs[key] + 1) % 3);
  }

  // === EDITABLE STATS ===
  const STAT_LABELS = {
    ac: 'AC', str: 'STR', dex: 'DEX', con: 'CON', int: 'INT', wis: 'WIS', cha: 'CHA',
    savStr: 'STR Save', savDex: 'DEX Save', savCon: 'CON Save',
    savInt: 'INT Save', savWis: 'WIS Save', savCha: 'CHA Save',
    passPerc: 'Passive Perception',
    initiative: 'Initiative modifier', speed: 'Walk speed (ft)',
    speedSwim: 'Swim speed (ft)', speedClimb: 'Climb speed (ft)', speedFly: 'Fly speed (ft)',
    levelLabel: 'Level & Class'
  };
  const STRING_STAT_KEYS = new Set(['levelLabel']);
  function editStat(key) {
    const label = STAT_LABELS[key] || key;
    const current = state.stats[key];
    const val = prompt(`Set ${label}:`, current);
    if (val === null || val.trim() === '') return;
    if (STRING_STAT_KEYS.has(key)) {
      update(s => s.stats[key] = val.trim());
    } else if (!isNaN(+val)) {
      update(s => s.stats[key] = +val);
    }
  }

  // === SENSES ===
  function toggleSenses() {
    update(s => s.sensesOpen = !s.sensesOpen);
  }
  function editSense(key) {
    const labels = { truesight: 'Truesight (ft)', blindsight: 'Blindsight (ft)', tremorsense: 'Tremorsense (ft)' };
    const val = prompt(labels[key] + ':', state.senses[key]);
    if (val !== null && !isNaN(+val)) update(s => s.senses[key] = Math.max(0, +val));
  }
  function renderSenses() {
    const { senses, sensesOpen } = state;
    const isEditing = editSection === 'senses';
    return `
      <div style="margin-top:8px;">
        <div class="panel-title" style="display:flex;align-items:center;justify-content:space-between;">
          <span onclick="toggleSenses()" style="cursor:pointer;flex:1;">Senses <span>${sensesOpen ? '‚ñ≤' : '‚ñº'}</span></span>
          ${isEditing
            ? `<span class="section-edit-controls">
                 <button class="edit-save-btn" onclick="saveSection('senses')">Save</button>
                 <button class="edit-cancel-btn" onclick="setEditSection(null)">‚úï</button>
               </span>`
            : `<button class="edit-pencil-btn" onclick="event.stopPropagation();setEditSection('senses')" title="Edit">‚úè</button>`
          }
        </div>
        ${sensesOpen || isEditing ? `
          <div class="senses-grid">
            ${isEditing ? `
              <div class="stat-row"><span class="stat-label">Truesight</span><input class="edit-input-sm" id="edit-truesight" type="number" value="${senses.truesight}"></div>
              <div class="stat-row"><span class="stat-label">Blindsight</span><input class="edit-input-sm" id="edit-blindsight" type="number" value="${senses.blindsight}"></div>
              <div class="stat-row"><span class="stat-label">Tremorsense</span><input class="edit-input-sm" id="edit-tremorsense" type="number" value="${senses.tremorsense}"></div>
            ` : `
              <div class="stat-row"><span class="stat-label">Truesight</span><span class="stat-value editable-stat" onclick="editSense('truesight')" title="Click to edit">${senses.truesight} ft</span></div>
              <div class="stat-row"><span class="stat-label">Blindsight</span><span class="stat-value editable-stat" onclick="editSense('blindsight')" title="Click to edit">${senses.blindsight} ft</span></div>
              <div class="stat-row"><span class="stat-label">Tremorsense</span><span class="stat-value editable-stat" onclick="editSense('tremorsense')" title="Click to edit">${senses.tremorsense} ft</span></div>
            `}
          </div>
        ` : ''}
      </div>
    `;
  }

  // === IMMUNITIES & RESISTANCES ===
  const DMG_TYPES = ['Acid','Bludgeoning','Cold','Fire','Force','Lightning','Necrotic','Piercing','Poison','Psychic','Radiant','Slashing','Thunder'];

  function renderImmRes() {
    const { immunities: imm, resistances: res, immResOpen: open } = state;
    const immTags = imm.length ? imm.map(t => `<span class="imm-tag imm">${t}</span>`).join('') : '<span class="imm-none">None</span>';
    const resTags = res.length ? res.map(t => `<span class="imm-tag res">${t}</span>`).join('') : '<span class="imm-none">None</span>';
    const chevron = open ? '‚ñ≤' : '‚ñº';
    return `
      <div class="panel-title" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" onclick="toggleImmResOpen()">
        <span>Immunities &amp; Resistances</span><span style="font-size:0.7rem;opacity:0.6">${chevron}</span>
      </div>
      <div class="imm-summary">
        <div class="imm-row-label">Immune:</div><div class="imm-tags">${immTags}</div>
        <div class="imm-row-label">Resist:</div><div class="imm-tags">${resTags}</div>
      </div>
      ${open ? `
      <div class="imm-picker">
        <div class="imm-col-head">Immunity</div><div class="imm-col-head">Resistance</div>
        ${DMG_TYPES.map(t => `
          <label class="imm-check ${imm.includes(t)?'active-imm':''}">
            <input type="checkbox" ${imm.includes(t)?'checked':''} onchange="toggleImmRes('${t}','imm',this.checked)"> ${t}
          </label>
          <label class="imm-check ${res.includes(t)?'active-res':''}">
            <input type="checkbox" ${res.includes(t)?'checked':''} onchange="toggleImmRes('${t}','res',this.checked)"> ${t}
          </label>
        `).join('')}
      </div>` : ''}
    `;
  }

  function toggleImmResOpen() {
    update(s => s.immResOpen = !s.immResOpen);
  }
  function toggleImmRes(type, category, checked) {
    update(s => {
      const arr = category === 'imm' ? s.immunities : s.resistances;
      const idx = arr.indexOf(type);
      if (checked && idx === -1) arr.push(type);
      if (!checked && idx !== -1) arr.splice(idx, 1);
    });
  }

  // === CONDITIONS ===
  const CONDITION_NAMES = [
    'Blinded','Charmed','Deafened','Exhaustion 1','Exhaustion 2','Exhaustion 3',
    'Exhaustion 4','Exhaustion 5','Exhaustion 6',
    'Frightened','Grappled','Incapacitated','Invisible',
    'Paralyzed','Petrified','Poisoned','Prone','Restrained','Stunned','Unconscious',
    'Custom...'
  ];

  function renderConditions() {
    const conds = state.conditions;
    const condListHTML = conds.length === 0
      ? '<div class="no-conds">No active conditions</div>'
      : conds.map((c, i) => {
          const durLabel = c.duration === null
            ? '<span class="cond-dur permanent">‚àû</span>'
            : `<span class="cond-dur">${c.duration}r</span>`;
          return `
            <div class="cond-item">
              <span class="cond-name">${c.name}</span>
              ${durLabel}
              <button class="cond-remove" onclick="removeCondition(${i})" title="Remove">‚úï</button>
            </div>`;
        }).join('');

    const optionsHTML = CONDITION_NAMES.map(n =>
      `<option value="${n}">${n}</option>`
    ).join('');

    return `
      <div class="panel-title" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Conditions</span>
        ${conds.length > 0 ? `<button class="btn-sm" onclick="tickConditions()" title="Advance one round">Next Turn</button>` : ''}
      </div>
      <div class="cond-section">
        <div class="cond-add-row">
          <select id="cond-select" onchange="onCondSelectChange(this)">
            <option value="" disabled selected>Add condition‚Ä¶</option>
            ${optionsHTML}
          </select>
          <input class="cond-dur-input" id="cond-dur" type="text" value="‚àû" title="Rounds (number) or ‚àû for permanent" maxlength="4">
          <button class="btn-cond-add" onclick="addCondition()">Add</button>
        </div>
        <div class="cond-custom-row" id="cond-custom-row">
          <input id="cond-custom-input" type="text" placeholder="Custom condition name‚Ä¶" style="flex:1;background:#0a1e2a;border:1px solid #1a3a4a;color:#c8dde8;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-family:'Inter',sans-serif;width:100%;">
        </div>
        <div class="cond-list">${condListHTML}</div>
        ${conds.length > 0 ? `<button class="btn-next-turn" onclick="tickConditions()">‚ü≥ Next Turn ‚Äî Tick Durations</button>` : ''}
      </div>
    `;
  }

  function onCondSelectChange(sel) {
    const customRow = document.getElementById('cond-custom-row');
    if (customRow) customRow.classList.toggle('visible', sel.value === 'Custom...');
  }

  function addCondition() {
    const sel = document.getElementById('cond-select');
    const durInput = document.getElementById('cond-dur');
    const customInput = document.getElementById('cond-custom-input');
    if (!sel || !sel.value) return;
    const isCustom = sel.value === 'Custom...';
    const name = isCustom ? (customInput ? customInput.value.trim() : '') : sel.value;
    if (!name) return;
    const rawDur = durInput ? durInput.value.trim() : '‚àû';
    const duration = (rawDur === '‚àû' || rawDur === '' || isNaN(+rawDur))
      ? null
      : Math.max(1, Math.round(+rawDur));
    update(s => {
      if (!s.conditions) s.conditions = [];
      s.conditions.push({ name, duration });
    });
  }

  function removeCondition(idx) {
    update(s => s.conditions.splice(idx, 1));
  }

  function tickConditions() {
    update(s => {
      if (!s.conditions) return;
      s.conditions = s.conditions
        .map(c => c.duration === null ? c : { ...c, duration: c.duration - 1 })
        .filter(c => c.duration === null || c.duration > 0);
    });
  }

  function shortRest() {
    if (state.hitDice.current === 0) {
      alert('No hit dice remaining.');
      return;
    }
    srDiceToSpend = 1;
    srRolls = [];
    srPhase = 'pick';
    renderSRModal();
    document.getElementById('short-rest-overlay').classList.remove('hidden');
  }

  function closeShortRest() {
    document.getElementById('short-rest-overlay').classList.add('hidden');
  }

  function srCloseOnBackdrop(event) {
    if (event.target === document.getElementById('short-rest-overlay')) closeShortRest();
  }

  function srAdjust(delta) {
    const max = state.hitDice.current;
    srDiceToSpend = Math.max(1, Math.min(max, srDiceToSpend + delta));
    renderSRModal();
  }

  function srRoll() {
    const die = parseInt(state.hitDice.dieType.replace('d', ''));
    const conMod = Math.floor((state.stats.con - 10) / 2);
    srRolls = Array.from({ length: srDiceToSpend }, () => {
      const roll = Math.floor(Math.random() * die) + 1;
      return { roll, conMod, total: roll + conMod };
    });
    srPhase = 'rolled';
    renderSRModal();
  }

  function srHeal() {
    const healAmount = srRolls.reduce((sum, r) => sum + r.total, 0);
    update(s => {
      s.hp.current = Math.min(s.hp.max + (s.hp.temp || 0), s.hp.current + healAmount);
      s.hitDice.current = Math.max(0, s.hitDice.current - srDiceToSpend);
    });
    closeShortRest();
  }

  function renderSRModal() {
    const { dieType, current } = state.hitDice;
    const body = document.getElementById('sr-body');
    if (srPhase === 'pick') {
      body.innerHTML = `
        <div class="sr-dice-count">${current} ${dieType} available</div>
        <div class="sr-picker">
          <button class="btn-sm" onclick="srAdjust(-1)">‚àí</button>
          <span class="sr-picker-val">${srDiceToSpend}</span>
          <button class="btn-sm" onclick="srAdjust(1)">+</button>
          <span style="font-size:0.8rem;color:#6a9aaa;">dice to spend</span>
        </div>
        <div class="sr-actions">
          <button class="btn-sm" onclick="srRoll()">Roll</button>
          <button class="btn-sm" onclick="closeShortRest()">Cancel</button>
        </div>
      `;
    } else {
      const healTotal = srRolls.reduce((sum, r) => sum + r.total, 0);
      const sign = srRolls[0].conMod >= 0 ? '+' : '';
      body.innerHTML = `
        <div class="sr-roll-list">
          ${srRolls.map(r =>
            `<div class="sr-roll-row">
              <span>‚ô• ${dieType} ‚Üí ${r.roll} ${sign}${r.conMod} CON</span>
              <span style="color:#a8d8e8;font-weight:600;">${r.total}</span>
            </div>`
          ).join('')}
        </div>
        <div class="sr-total">Heal for ${healTotal} HP</div>
        <div class="sr-actions">
          <button class="btn-sm" onclick="srHeal()">Heal</button>
          <button class="btn-sm" onclick="closeShortRest()">Cancel</button>
        </div>
      `;
    }
  }

  function longRest() {
    if (confirm('Long rest? This restores HP and resets strain.')) {
      update(s => {
        s.hp.current = s.hp.max;
        s.strain = { body: 0, mind: 0, soul: 0 };
        s.concentration = [];
      });
    }
  }

  function exportCharacter() {
    const filename = (state.characterName || 'character').replace(/[^a-z0-9_\-]/gi, '_') + '.json';
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importCharacter() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const parsed = JSON.parse(evt.target.result);
          const required = ['hp', 'stats', 'characterName'];
          for (const key of required) {
            if (!(key in parsed)) throw new Error('Missing key: ' + key);
          }
          update(s => Object.assign(s, parsed));
        } catch (err) { alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  // === STAT BLOCKS ===
  const statBlocks = new Map(); // id ‚Üí { name, type, url }
  let sbNextId = 0;
  let activeStatId = null;

  function handleFileDrop(e) {
    e.preventDefault();
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    Array.from(e.dataTransfer.files).forEach(file => {
      if (!file.type.startsWith('image/') && file.type !== 'application/pdf') return;
      const url = URL.createObjectURL(file);
      const id = String(sbNextId++);
      const name = file.name.replace(/\.[^.]+$/, '');
      statBlocks.set(id, { name, type: file.type, url });
      activeStatId = id;
      renderStatPanel();
    });
  }

  let imgZoom = 1.0;

  function adjustZoom(delta) {
    imgZoom = Math.max(0.25, Math.min(4.0, imgZoom + delta));
    applyZoom();
  }
  function resetZoom() {
    imgZoom = 1.0;
    applyZoom();
  }
  function applyZoom() {
    const img = document.querySelector('#stat-preview img');
    if (img) img.style.width = (imgZoom * 100) + '%';
    const lbl = document.getElementById('zoom-display');
    if (lbl) lbl.textContent = Math.round(imgZoom * 100) + '%';
  }

  function selectStatBlock(id) {
    activeStatId = id;
    imgZoom = 1.0;
    renderStatPanel();
    renderHeader();
  }

  function activateStatBlock(id) {
    if (!statPanelOpen) {
      statPanelOpen = true;
      const panel = document.getElementById('stat-panel');
      panel.classList.add('open');
      panel.style.left = ''; panel.style.top = '';
      panel.style.right = '20px';
    }
    selectStatBlock(id);
  }

  function removeStatBlock(id) {
    const sb = statBlocks.get(id);
    if (sb) URL.revokeObjectURL(sb.url);
    statBlocks.delete(id);
    if (activeStatId === id) activeStatId = statBlocks.size > 0 ? statBlocks.keys().next().value : null;
    renderStatPanel();
    renderHeader();
  }

  function renderStatPanel() {
    // Preview
    const preview = document.getElementById('stat-preview');
    const active = activeStatId ? statBlocks.get(activeStatId) : null;
    const zoomBar = document.getElementById('stat-zoom-controls');
    if (active) {
      if (active.type.startsWith('image/')) {
        preview.innerHTML = `<img src="${active.url}" alt="${active.name}" style="width:${imgZoom*100}%">`;
        zoomBar.classList.add('visible');
      } else {
        preview.innerHTML = `<embed src="${active.url}" type="application/pdf">`;
        zoomBar.classList.remove('visible');
      }
      document.getElementById('zoom-display').textContent = Math.round(imgZoom * 100) + '%';
    } else {
      preview.innerHTML = `<div class="stat-preview-hint">Drop a stat block image or PDF anywhere</div>`;
      zoomBar.classList.remove('visible');
    }

    // Thumbnails
    const thumbs = document.getElementById('stat-thumbs');
    const cards = Array.from(statBlocks.entries()).map(([id, sb]) => {
      const thumb = sb.type.startsWith('image/')
        ? `<img src="${sb.url}" alt="${sb.name}">`
        : `<span class="pdf-icon-thumb">üìÑ</span>`;
      const activeCls = id === activeStatId ? ' active' : '';
      return `
        <div class="stat-card${activeCls}" onclick="selectStatBlock('${id}')">
          <div class="stat-card-thumb">
            ${thumb}
            <div class="stat-card-remove" onclick="event.stopPropagation(); removeStatBlock('${id}')">‚úï</div>
          </div>
          <div class="stat-card-name">${sb.name}</div>
        </div>`;
    }).join('');

    thumbs.innerHTML = `
      <button class="btn-sm" onclick="pickStatFile()" style="width:100%;margin-bottom:8px;">+ Add</button>
      ${cards}
      <div class="drop-hint-strip">Drop files here</div>`;
  }

  function pickStatFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,.pdf';
    input.multiple = true;
    input.onchange = e => {
      Array.from(e.target.files).forEach(file => {
        const url = URL.createObjectURL(file);
        const id = String(sbNextId++);
        const name = file.name.replace(/\.[^.]+$/, '');
        statBlocks.set(id, { name, type: file.type, url });
        activeStatId = id;
      });
      if (!statPanelOpen) {
        statPanelOpen = true;
        const panel = document.getElementById('stat-panel');
        panel.classList.add('open');
        panel.style.left = ''; panel.style.top = '';
        panel.style.right = '20px';
        statMinimized = false;
        panel.classList.remove('minimized');
      }
      renderStatPanel();
      renderHeader();
    };
    input.click();
  }

  // === STAT PANEL ===
  let statPanelOpen = false;
  let draggingPanel = false;
  let dragOffsetX = 0, dragOffsetY = 0;
  let draggingLore = false;
  let loreDragOffsetX = 0, loreDragOffsetY = 0;
  let loreResizeState = null;
  let loreMinimized = false;
  let lorePageMenuOpen = false;

  function toggleLorePanel() {
    const panel = document.getElementById('lore-panel');
    if (!panel) return;
    const isOpen = panel.classList.contains('open');
    panel.classList.toggle('open', !isOpen);
    if (!isOpen) {
      loreMinimized = false;
      panel.classList.remove('minimized');
      document.getElementById('lore-minimize-btn').textContent = '‚Äî';
      renderLorePanel();
    }
  }

  function toggleLoreMinimize() {
    loreMinimized = !loreMinimized;
    document.getElementById('lore-panel').classList.toggle('minimized', loreMinimized);
    document.getElementById('lore-minimize-btn').textContent = loreMinimized ? '‚ñ°' : '‚Äî';
  }

  function toggleLorePageMenu(e) {
    e.stopPropagation();
    lorePageMenuOpen = !lorePageMenuOpen;
    document.getElementById('lore-page-menu').classList.toggle('hidden', !lorePageMenuOpen);
  }

  function toggleStatPanel() {
    statPanelOpen = !statPanelOpen;
    const panel = document.getElementById('stat-panel');
    panel.classList.toggle('open', statPanelOpen);
    if (statPanelOpen) {
      panel.style.left = ''; panel.style.top = '';
      panel.style.right = '20px';
      statMinimized = false;
      panel.classList.remove('minimized');
    }
    renderHeader();
  }

  function closeStatPanel() {
    statPanelOpen = false;
    document.getElementById('stat-panel').classList.remove('open');
    renderHeader();
  }

  let statMinimized = false;
  let panelResizeState = null;

  function panelZoom() {
    return parseFloat(getComputedStyle(document.documentElement).zoom) || 1;
  }

  function startPanelResize(e, edge) {
    e.preventDefault();
    e.stopPropagation();
    const z = panelZoom();
    const panel = document.getElementById('stat-panel');
    const rect = panel.getBoundingClientRect();
    panel.style.right = 'auto';
    panel.style.left = rect.left + 'px';
    panel.style.top  = rect.top  + 'px';
    const cursors = { n:'ns-resize', s:'ns-resize', e:'ew-resize', w:'ew-resize', nw:'nwse-resize', se:'nwse-resize', ne:'nesw-resize', sw:'nesw-resize' };
    panelResizeState = {
      edge,
      startX: e.clientX / z, startY: e.clientY / z,
      startW: rect.width, startH: rect.height,
      startLeft: rect.left, startTop: rect.top,
    };
    const shield = document.getElementById('drag-shield');
    shield.style.cursor = cursors[edge] || 'default';
    shield.classList.add('active');
    document.body.style.userSelect = 'none';
  }

  function startLoreResize(e, edge) {
    e.preventDefault();
    e.stopPropagation();
    const z = panelZoom();
    const panel = document.getElementById('lore-panel');
    const rect = panel.getBoundingClientRect();
    panel.style.left = rect.left + 'px';
    panel.style.top  = rect.top  + 'px';
    const cursors = { n:'ns-resize', s:'ns-resize', e:'ew-resize', w:'ew-resize', nw:'nwse-resize', se:'nwse-resize', ne:'nesw-resize', sw:'nesw-resize' };
    loreResizeState = {
      edge,
      startX: e.clientX / z, startY: e.clientY / z,
      startW: rect.width, startH: rect.height,
      startLeft: rect.left, startTop: rect.top,
    };
    const shield = document.getElementById('drag-shield');
    shield.style.cursor = cursors[edge] || 'default';
    shield.classList.add('active');
    document.body.style.userSelect = 'none';
  }

  function toggleStatMinimize() {
    statMinimized = !statMinimized;
    document.getElementById('stat-panel').classList.toggle('minimized', statMinimized);
    document.getElementById('stat-minimize-btn').textContent = statMinimized ? '‚ñ°' : '‚Äî';
  }

  document.getElementById('stat-titlebar').addEventListener('mousedown', e => {
    if (e.target.tagName === 'BUTTON') return;
    draggingPanel = true;
    const z = panelZoom();
    const panel = document.getElementById('stat-panel');
    const rect = panel.getBoundingClientRect();
    panel.style.right = 'auto';
    panel.style.left = rect.left + 'px';
    panel.style.top  = rect.top  + 'px';
    dragOffsetX = e.clientX / z - rect.left;
    dragOffsetY = e.clientY / z - rect.top;
    const shield = document.getElementById('drag-shield');
    shield.style.cursor = 'grabbing';
    shield.classList.add('active');
    document.body.style.cursor = 'grabbing';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  document.getElementById('lore-titlebar').addEventListener('mousedown', e => {
    if (e.target.tagName === 'BUTTON') return;
    draggingLore = true;
    const z = panelZoom();
    const panel = document.getElementById('lore-panel');
    const rect = panel.getBoundingClientRect();
    panel.style.left = rect.left + 'px';
    panel.style.top  = rect.top  + 'px';
    loreDragOffsetX = e.clientX / z - rect.left;
    loreDragOffsetY = e.clientY / z - rect.top;
    const shield = document.getElementById('drag-shield');
    shield.style.cursor = 'grabbing';
    shield.classList.add('active');
    document.body.style.cursor = 'grabbing';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  // === DICE ROLLER ===
  function rollDice(sides) {
    const countEl = document.getElementById('dice-count');
    const modEl = document.getElementById('dice-modifier');
    diceCount = countEl ? Math.max(1, Math.min(4, parseInt(countEl.value) || 1)) : diceCount;
    diceModifier = modEl ? (parseInt(modEl.value) || 0) : diceModifier;
    const rolls = Array.from({ length: diceCount }, () => Math.floor(Math.random() * sides) + 1);
    const total = rolls.reduce((a, b) => a + b, 0) + diceModifier;
    const detail = diceCount > 1
      ? `[${rolls.join(' + ')}]${diceModifier !== 0 ? (diceModifier > 0 ? ' + ' : ' ‚àí ') + Math.abs(diceModifier) : ''}`
      : (diceModifier !== 0 ? (diceModifier > 0 ? `+${diceModifier}` : `${diceModifier}`) : '');
    const expr = `${diceCount}d${sides}${diceModifier > 0 ? '+' + diceModifier : diceModifier < 0 ? diceModifier : ''}`;
    diceHistory.unshift({ expr, total, detail });
    if (diceHistory.length > 5) diceHistory.pop();
    renderDicePanel();
  }

  function renderDicePanel() {
    const panel = document.getElementById('dice-panel');
    if (!panel) return;
    const dies = [4, 6, 8, 10, 12, 20, 100];
    const latest = diceHistory[0];
    const history = diceHistory.slice(1);
    panel.innerHTML = `
      <div class="dice-btn-row">
        ${dies.map(d => `<button class="btn-die" onclick="rollDice(${d})">d${d}</button>`).join('')}
      </div>
      <div class="dice-controls-row">
        <label>Count</label>
        <input id="dice-count" type="number" min="1" max="4" value="${diceCount}">
        <label>Mod</label>
        <input id="dice-modifier" type="number" value="${diceModifier}">
      </div>
      ${latest ? `
        <div class="dice-result">
          <div class="dice-result-label">Result</div>
          <div class="dice-result-value">${latest.total}</div>
          ${latest.detail ? `<div class="dice-result-detail">${latest.detail}</div>` : ''}
        </div>` : ''}
      ${history.length > 0 ? `
        <div class="dice-history">
          ${history.map(h => `
            <div class="dice-history-item">
              <span class="dice-hist-expr">${h.expr}</span>
              <span class="dice-hist-val">${h.total}</span>
            </div>`).join('')}
        </div>` : ''}
    `;
  }

  function toggleDicePanel() {
    diceMenuOpen = !diceMenuOpen;
    const panel = document.getElementById('dice-panel');
    if (panel) panel.classList.toggle('open', diceMenuOpen);
    if (diceMenuOpen) renderDicePanel();
  }

  // === HEADER ===
  let restMenuOpen = false;
  let materialsMenuOpen = false;
  let conditionsMenuOpen = false;

  const CONDITIONS = [
    { name: 'Blinded',        effect: "Can't see; auto-fails sight-based checks. Attackers have advantage; creature has disadvantage on attacks." },
    { name: 'Charmed',        effect: "Can't attack the charmer or target them with harmful effects. Charmer has advantage on social checks with the creature." },
    { name: 'Deafened',       effect: "Can't hear; auto-fails hearing-based checks." },
    { name: 'Exhaustion',     effect: "Level 1: Disadvantage on ability checks. Level 2: Speed halved. Level 3: Disadvantage on attacks and saves. Level 4: HP max halved. Level 5: Speed = 0. Level 6: Death. Each long rest removes one level." },
    { name: 'Frightened',     effect: "Disadvantage on ability checks and attack rolls while the source is in sight. Can't willingly move closer to the source." },
    { name: 'Grappled',       effect: "Speed becomes 0. Ends if the grappler is incapacitated or the creature is removed from reach." },
    { name: 'Incapacitated',  effect: "Can't take actions or reactions." },
    { name: 'Invisible',      effect: "Can't be seen without magic or special senses. Creature's attacks have advantage; attacks against it have disadvantage." },
    { name: 'Paralyzed',      effect: "Incapacitated; can't move or speak. Auto-fails STR and DEX saves. Attackers have advantage. Hits from within 5 ft are critical hits." },
    { name: 'Petrified',      effect: "Transformed to inanimate substance. Incapacitated; unaware of surroundings. Auto-fails STR and DEX saves. Attackers have advantage. Resistance to all damage. Immune to poison and disease (existing ones suspended)." },
    { name: 'Poisoned',       effect: "Disadvantage on attack rolls and ability checks." },
    { name: 'Prone',          effect: "Can only crawl unless it stands up (costs half speed). Disadvantage on attacks. Attackers within 5 ft have advantage; others have disadvantage." },
    { name: 'Restrained',     effect: "Speed becomes 0. Attackers have advantage. Creature has disadvantage on attacks and DEX saves." },
    { name: 'Stunned',        effect: "Incapacitated; can't move; speaks only falteringly. Auto-fails STR and DEX saves. Attackers have advantage." },
    { name: 'Unconscious',    effect: "Incapacitated; unaware; drops held items; falls prone. Auto-fails STR and DEX saves. Attackers have advantage. Hits from within 5 ft are critical hits." },
  ];

  function toggleFormulaPanel() {
    const panel = document.getElementById('formula-panel');
    panel.classList.toggle('open');
  }
  document.addEventListener('click', e => {
    const wrap = document.querySelector('.formula-dropdown-wrap');
    if (wrap && !wrap.contains(e.target)) {
      document.getElementById('formula-panel')?.classList.remove('open');
    }
  });
  document.addEventListener('click', e => {
    if (diceMenuOpen && !e.composedPath().some(el => el.classList?.contains('dice-dropdown-wrap'))) {
      diceMenuOpen = false;
      document.getElementById('dice-panel')?.classList.remove('open');
    }
  });

  function editCharacterName() {
    const val = prompt('Character name:', state.characterName);
    if (val !== null && val.trim() !== '') update(s => s.characterName = val.trim());
  }
  function renderHeader() {
    document.getElementById('app-header').innerHTML = `
      <h1 onclick="editCharacterName()" title="Click to rename" style="cursor:pointer">${state.characterName}</h1>
      <span onclick="editStat('levelLabel')" title="Click to edit level &amp; class" style="cursor:pointer;font-size:0.8rem;color:#5a8a9a;margin-left:2px;margin-right:8px;white-space:nowrap;">${state.stats.levelLabel}</span>
      <div class="rest-dropdown-wrap">
        <button class="rest-menu-btn" onclick="toggleRestMenu()">‚ö° Rests ‚ñæ</button>
        <div id="rest-menu" class="rest-menu${restMenuOpen ? '' : ' hidden'}">
          <button onclick="shortRest()">Short Rest</button>
          <button onclick="longRest()">Long Rest</button>
          <hr style="border:none;border-top:1px solid #0f2535;margin:2px 0;">
          <button onclick="exportCharacter()">Export‚Ä¶</button>
          <button onclick="importCharacter()">Import‚Ä¶</button>
        </div>
      </div>
      <div class="materials-dropdown-wrap">
        <button class="formula-dropdown-btn${statPanelOpen ? ' stat-tab-btn active' : ''}" onclick="toggleMaterialsMenu(event)">Materials ‚ñæ</button>
        <div id="materials-menu" class="materials-menu${materialsMenuOpen ? '' : ' hidden'}">
          ${Array.from(statBlocks.entries()).map(([id, sb]) => {
            const isActive = id === activeStatId;
            const icon = sb.type.startsWith('image/') ? 'üñº' : 'üìÑ';
            return `<button class="${isActive ? 'mat-active' : ''}" onclick="selectMaterial('${id}')" title="${sb.name}">${icon} ${sb.name}</button>`;
          }).join('')}
          ${statBlocks.size > 0 ? '<hr class="mat-divider">' : ''}
          <button onclick="openMaterialFile()">+ Add file‚Ä¶</button>
        </div>
      </div>
      <div class="conditions-dropdown-wrap">
        <button class="formula-dropdown-btn" onclick="toggleConditionsPanel(); event.stopPropagation();">Conditions ‚ñæ</button>
        <div class="conditions-panel${conditionsMenuOpen ? '' : ' hidden'}" id="conditions-panel">
          ${CONDITIONS.map(c => `
            <div class="condition-entry">
              <div class="condition-name">${c.name}</div>
              <div class="condition-effect">${c.effect}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="formula-dropdown-wrap">
        <button class="formula-dropdown-btn" onclick="toggleFormulaPanel(); event.stopPropagation();">Formulas ‚ñæ</button>
        <div class="formula-panel" id="formula-panel">
          <div class="formula-row"><span class="formula-lhs">Attack Roll</span><span>= d20 + Ability Mod + Proficiency</span></div>
          <div class="formula-row"><span class="formula-lhs">Power Attack</span><span>= d20 + INT Mod + Proficiency &nbsp;<strong style="color:#2ab8d0;">+${getPowerAtk()}</strong></span></div>
          <div class="formula-row"><span class="formula-lhs">Power Save DC</span><span>= 8 + INT Mod + Proficiency &nbsp;<strong style="color:#2ab8d0;">${getPowerSaveDC()}</strong></span></div>
        </div>
      </div>
      <div class="dice-dropdown-wrap">
        <button class="dice-dropdown-btn"
          onclick="toggleDicePanel(); event.stopPropagation();">üé≤ Roll ‚ñæ</button>
        <div class="dice-panel" id="dice-panel"></div>
      </div>
      <button class="formula-dropdown-btn" onclick="toggleLorePanel()" style="margin-left:4px;">üìñ Lore</button>
      <button class="btn-help" onclick="openHelp()" title="Quick Start Guide" style="margin-left:8px;">?</button>
    `;
  }
  function toggleRestMenu() {
    restMenuOpen = !restMenuOpen;
    const menu = document.getElementById('rest-menu');
    if (menu) menu.classList.toggle('hidden', !restMenuOpen);
  }
  // Close rest menu when clicking outside
  document.addEventListener('click', e => {
    if (restMenuOpen && !e.target.closest('.rest-dropdown-wrap')) {
      restMenuOpen = false;
      const menu = document.getElementById('rest-menu');
      if (menu) menu.classList.add('hidden');
    }
  });
  // Close lore page menu when clicking outside
  document.addEventListener('click', e => {
    if (lorePageMenuOpen && !e.target.closest('#lore-page-dropdown-wrap')) {
      lorePageMenuOpen = false;
      document.getElementById('lore-page-menu')?.classList.add('hidden');
    }
  });
  function toggleMaterialsMenu(e) {
    e.stopPropagation();
    materialsMenuOpen = !materialsMenuOpen;
    const menu = document.getElementById('materials-menu');
    if (menu) menu.classList.toggle('hidden', !materialsMenuOpen);
    if (materialsMenuOpen && !statPanelOpen) {
      statPanelOpen = true;
      const panel = document.getElementById('stat-panel');
      panel.classList.add('open');
      panel.style.left = ''; panel.style.top = '';
      panel.style.right = '20px';
      statMinimized = false;
      panel.classList.remove('minimized');
      renderHeader();
    }
  }
  function selectMaterial(id) {
    materialsMenuOpen = false;
    document.getElementById('materials-menu')?.classList.add('hidden');
    activateStatBlock(id);
  }
  function openMaterialFile() {
    materialsMenuOpen = false;
    document.getElementById('materials-menu')?.classList.add('hidden');
    pickStatFile();
  }
  // Close materials menu when clicking outside
  document.addEventListener('click', e => {
    if (materialsMenuOpen && !e.target.closest('.materials-dropdown-wrap')) {
      materialsMenuOpen = false;
      const menu = document.getElementById('materials-menu');
      if (menu) menu.classList.add('hidden');
    }
  });
  function toggleConditionsPanel() {
    conditionsMenuOpen = !conditionsMenuOpen;
    const panel = document.getElementById('conditions-panel');
    if (panel) panel.classList.toggle('hidden', !conditionsMenuOpen);
  }
  document.addEventListener('click', e => {
    if (conditionsMenuOpen && !e.target.closest('.conditions-dropdown-wrap')) {
      conditionsMenuOpen = false;
      document.getElementById('conditions-panel')?.classList.add('hidden');
    }
  });

  // === ATTUNED ITEMS ===
  function increaseAttunementMax() {
    update(s => s.attunementMax++);
  }
  function decreaseAttunementMax() {
    const attuned = state.items.filter(i => i.attuned).length;
    update(s => s.attunementMax = Math.max(attuned, s.attunementMax - 1));
  }

  // === MAGIC ITEMS ===
  function addMagicItem() {
    const name = prompt('Magic item name:');
    if (!name) return;
    update(s => s.items.push({
      id: String(Date.now()),
      name: name.trim(),
      qty: '1',
      description: '',
      type: 'magic',
      equipped: false,
      attuned: false,
      chargeMax: 0,
      chargeCurrent: 0
    }));
  }
  function editMagicItemName(id) {
    const item = state.items.find(i => i.id === id);
    if (!item) return;
    const name = prompt('Magic item name:', item.name);
    if (name !== null && name.trim()) update(s => { const i = s.items.find(i => i.id === id); if (i) i.name = name.trim(); });
  }
  function clickChargePip(id, idx) {
    update(s => {
      const item = s.items.find(i => i.id === id);
      if (!item) return;
      // Click filled pip = spend down to that index; click empty = restore up to idx+1
      item.chargeCurrent = item.chargeCurrent > idx ? idx : idx + 1;
    });
  }
  function setItemChargeMax(id, val) {
    const max = Math.max(0, parseInt(val) || 0);
    update(s => {
      const item = s.items.find(i => i.id === id);
      if (!item) return;
      const wasOff = item.chargeMax === 0;
      item.chargeMax = max;
      if (wasOff && max > 0) {
        item.chargeCurrent = max; // Start full when first enabled
      } else {
        item.chargeCurrent = Math.min(item.chargeCurrent, max);
      }
    });
  }
  function toggleEquipped(id) {
    update(s => { const i = s.items.find(i => i.id === id); if (i) i.equipped = !i.equipped; });
  }
  function toggleAttuned(id) {
    update(s => { const i = s.items.find(i => i.id === id); if (i) i.attuned = !i.attuned; });
  }

  // === INVENTORY / ITEM DESC / QTY / CURRENCY ===
  function toggleItemDesc(id) {
    itemDescOpen[id] = !itemDescOpen[id];
    render();
  }
  function startEditDesc(id) {
    itemDescEdit = id;
    render();
  }
  function cancelEditDesc() {
    itemDescEdit = null;
    render();
  }
  function saveItemDesc(id) {
    const val = document.getElementById('edit-desc-' + id)?.value ?? '';
    update(s => {
      const item = s.items.find(i => i.id === id);
      if (item) item.description = val;
    });
    itemDescEdit = null;
  }
  function adjustItemQty(id, delta) {
    update(s => {
      const item = s.items.find(i => i.id === id);
      if (!item) return;
      const cur = parseInt(item.qty) || 1;
      item.qty = String(Math.max(1, cur + delta));
    });
  }
  function setCurrency(field, val) {
    const n = parseInt(val);
    if (!isNaN(n)) { state.currency[field] = Math.max(0, n); saveState(); }
  }
  function toggleInventory() {
    update(s => s.inventoryOpen = !s.inventoryOpen);
  }
  function openHelp() {
    helpOpen = true;
    document.getElementById('help-overlay').classList.remove('hidden');
  }
  function closeHelp() {
    helpOpen = false;
    document.getElementById('help-overlay').classList.add('hidden');
  }
  function closeHelpOnBackdrop(event) {
    if (event.target === document.getElementById('help-overlay')) closeHelp();
  }
  function addInventoryItem() {
    const name = prompt('Item name:');
    if (!name) return;
    update(s => s.items.push({
      id: String(Date.now()),
      name: name.trim(),
      qty: '1',
      description: '',
      type: 'normal',
      equipped: false,
      attuned: false
    }));
  }
  function removeItem(id) {
    update(s => s.items = s.items.filter(i => i.id !== id));
  }
  function editInventoryItem(id) {
    const item = state.items.find(i => i.id === id);
    if (!item) return;
    const name = prompt('Item name:', item.name);
    if (name === null) return;
    const qty = prompt('Quantity:', item.qty);
    update(s => {
      const i = s.items.find(i => i.id === id);
      if (!i) return;
      i.name = name.trim();
      i.qty = (qty ?? item.qty).trim();
    });
  }
  // === FEATS ===
  let featDescOpen = {};
  let featDescEdit = null;

  function addFeat() {
    const name = prompt('Feat name:');
    if (!name) return;
    update(s => s.feats.push({ id: String(Date.now()), name: name.trim(), description: '' }));
  }
  function removeFeat(id) {
    featDescOpen[id] = false;
    if (featDescEdit === id) featDescEdit = null;
    update(s => s.feats = s.feats.filter(f => f.id !== id));
  }
  function editFeatName(id) {
    const feat = state.feats.find(f => f.id === id);
    if (!feat) return;
    const val = prompt('Feat name:', feat.name);
    if (val !== null && val.trim()) update(s => { const f = s.feats.find(f => f.id === id); if (f) f.name = val.trim(); });
  }
  function toggleFeatDesc(id) {
    featDescOpen[id] = !featDescOpen[id];
    render();
  }
  function startEditFeatDesc(id) {
    featDescEdit = id;
    render();
  }
  function cancelEditFeatDesc() {
    featDescEdit = null;
    render();
  }
  function saveFeatDesc(id) {
    const val = document.getElementById('feat-desc-' + id)?.value ?? '';
    update(s => { const f = s.feats.find(f => f.id === id); if (f) f.description = val; });
    featDescEdit = null;
  }
  function toggleFeatsSection() {
    update(s => s.featsOpen = !s.featsOpen);
  }
  function renderFeats() {
    const { feats, featsOpen } = state;
    return `
      <div class="panel-title" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Feats</span>
        <span style="display:flex;gap:4px;align-items:center;">
          ${featsOpen ? `<button class="btn-add-inv" style="padding:2px 8px;font-size:0.7rem;" onclick="event.stopPropagation();addFeat()">+ Feat</button>` : ''}
          <button class="btn-sm" onclick="toggleFeatsSection()" style="padding:0 6px;">${featsOpen ? '‚ñ≤' : '‚ñº'}</button>
        </span>
      </div>
      ${featsOpen ? `
        ${feats.length === 0
          ? '<div style="font-size:0.75rem;color:#2a4a5a;padding:4px 0;">No feats added</div>'
          : feats.map(f => {
              const open    = featDescOpen[f.id];
              const editing = featDescEdit === f.id;
              return `
                <div style="padding:4px 0;border-bottom:1px solid #0f2535;">
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span style="font-size:0.8rem;color:#8ab8c8;cursor:pointer;"
                      ondblclick="editFeatName('${f.id}')"
                      title="Double-click to rename">${f.name}</span>
                    <span style="display:flex;gap:4px;">
                      <button class="btn-sm" onclick="toggleFeatDesc('${f.id}')" style="padding:0 5px;">${open ? '‚ñ≤' : '‚ñº'}</button>
                      <button class="btn-sm" onclick="removeFeat('${f.id}')" style="padding:0 5px;color:#a05050;">‚úï</button>
                    </span>
                  </div>
                  ${open ? `
                    <div style="padding:4px 0 2px 0;">
                      ${editing ? `
                        <textarea id="feat-desc-${f.id}"
                          style="width:100%;min-height:60px;background:#0a1a24;color:#c8dde8;border:1px solid #1a3a4a;border-radius:4px;padding:4px;font-size:0.75rem;font-family:'Inter',sans-serif;resize:vertical;">${f.description}</textarea>
                        <div style="display:flex;gap:4px;margin-top:4px;">
                          <button class="edit-save-btn" onclick="saveFeatDesc('${f.id}')">Save</button>
                          <button class="edit-cancel-btn" onclick="cancelEditFeatDesc()">‚úï</button>
                        </div>
                      ` : `
                        <div style="font-size:0.75rem;color:#6a9aaa;white-space:pre-wrap;min-height:16px;cursor:text;"
                          ondblclick="startEditFeatDesc('${f.id}')"
                          title="Double-click to edit">${f.description || '<em style="color:#2a4a5a;">No description</em>'}</div>
                      `}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')
        }
      ` : ''}
    `;
  }

  // === UNIFIED INVENTORY ===
  function renderInventory() {
    const { items, inventoryOpen, attunementMax, currency } = state;
    const normalItems  = items.filter(i => i.type === 'normal');
    const magicItems   = items.filter(i => i.type === 'magic');
    const attunedItems = items.filter(i => i.attuned);
    const attunedCount = attunedItems.length;
    const over = attunedCount > attunementMax;

    function itemRow(i, isMagic) {
      const qty = parseInt(i.qty) || 1;
      const descOpen = itemDescOpen[i.id];
      const editing  = itemDescEdit === i.id;
      const editFn   = isMagic ? `editMagicItemName('${i.id}')` : `editInventoryItem('${i.id}')`;
      return `
        <div>
          <div class="inventory-item">
            <button class="btn-sm" onclick="adjustItemQty('${i.id}',-1)" style="padding:0 5px;">‚àí</button>
            <span style="font-size:0.75rem;color:#5a8a9a;min-width:24px;text-align:center;">√ó${qty}</span>
            <button class="btn-sm" onclick="adjustItemQty('${i.id}',1)" style="padding:0 5px;">+</button>
            <span class="${isMagic ? 'magic-item-name' : 'inv-name'}" onclick="toggleItemDesc('${i.id}')" ondblclick="${editFn}" title="Click to expand ¬∑ Double-click to rename" style="flex:1;margin-left:6px;cursor:pointer;">${i.name}</span>
            ${isMagic ? `
              <button class="btn-toggle ${i.equipped ? 'active-equipped' : ''}" onclick="toggleEquipped('${i.id}')">Eqp</button>
              <button class="btn-toggle ${i.attuned ? 'active-attuned' : ''}" onclick="toggleAttuned('${i.id}')">Att</button>
            ` : ''}
            <button class="btn-sm" onclick="toggleItemDesc('${i.id}')" title="Description" style="padding:0 5px;opacity:${(i.description || isMagic) ? 1 : 0.4};">${descOpen ? '‚ñº' : '‚ñ∂'}</button>
            <button class="btn-remove-inv" onclick="removeItem('${i.id}')">‚úï</button>
          </div>
          ${isMagic && i.chargeMax > 0 ? `
            <div style="padding:1px 0 3px 32px;display:flex;align-items:center;gap:3px;">
              <span style="font-size:0.65rem;color:#c8904a;margin-right:2px;">‚ö°</span>
              ${Array.from({length: i.chargeMax}, (_, idx) => `
                <span onclick="clickChargePip('${i.id}',${idx})" title="${idx < i.chargeCurrent ? 'Click to spend' : 'Click to restore'}"
                  style="cursor:pointer;display:inline-block;width:9px;height:9px;border-radius:50%;
                         background:${idx < i.chargeCurrent ? '#c8904a' : 'transparent'};
                         border:1px solid ${idx < i.chargeCurrent ? '#c8904a' : '#3a5a6a'};"></span>
              `).join('')}
              <span style="font-size:0.65rem;color:#6a9aaa;margin-left:3px;">${i.chargeCurrent}/${i.chargeMax}</span>
            </div>
          ` : ''}
          ${descOpen ? `
            <div style="padding:4px 6px 4px 10px;background:#0a1825;border-left:2px solid #1a3a4a;margin-bottom:4px;">
              ${isMagic ? `
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
                  <span style="font-size:0.65rem;color:#c8904a;">‚ö°</span>
                  <span style="font-size:0.72rem;color:#5a8a9a;">Charges:</span>
                  <input type="number" min="0" max="20" value="${i.chargeMax}"
                    onchange="setItemChargeMax('${i.id}',this.value)"
                    style="width:40px;background:#0f2535;border:1px solid #1a3a4a;color:#8ab8c8;padding:2px 4px;border-radius:3px;font-size:0.72rem;text-align:center;"
                    title="Max charges (0 = disabled)">
                  <span style="font-size:0.65rem;color:#2a4a5a;">max (0 = off)</span>
                </div>
              ` : ''}
              ${editing ? `
                <textarea id="edit-desc-${i.id}" style="width:100%;background:#0f2535;border:1px solid #1a3a4a;color:#8ab8c8;padding:4px;border-radius:3px;font-size:0.75rem;resize:vertical;min-height:48px;">${i.description}</textarea>
                <div style="display:flex;gap:4px;margin-top:4px;">
                  <button class="btn-sm" onclick="saveItemDesc('${i.id}')">Save</button>
                  <button class="btn-sm" onclick="cancelEditDesc()">Cancel</button>
                </div>
              ` : `
                <div style="font-size:0.75rem;color:#6a9aaa;white-space:pre-wrap;min-height:16px;cursor:text;"
                  ondblclick="startEditDesc('${i.id}')"
                  title="Double-click to edit">${i.description || '<em style="color:#2a4a5a;">No description</em>'}</div>
              `}
            </div>
          ` : ''}
        </div>
      `;
    }

    const slotMax = Math.max(attunementMax, attunedCount);
    const pips = Array.from({ length: slotMax }, (_, idx) =>
      `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;margin:0 2px;background:${idx < attunedCount ? '#7070d8' : 'transparent'};border:1px solid ${idx < attunedCount ? '#7070d8' : '#3a4a6a'};"></span>`
    ).join('');

    const currencyRow = `
      <div style="border-top:1px solid #0f2535;margin-top:8px;padding-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        ${['pp','gp','sp','cp'].map(c => `
          <span style="display:flex;align-items:center;gap:3px;font-size:0.75rem;color:#8ab8c8;">
            <span style="color:#5a8a9a;text-transform:uppercase;">${c}</span>
            <input type="number" min="0" value="${currency[c]}" onchange="setCurrency('${c}',this.value)"
              style="width:44px;background:#0f2535;border:1px solid #1a3a4a;color:#8ab8c8;padding:2px 4px;border-radius:3px;font-size:0.75rem;text-align:right;">
          </span>
        `).join('')}
      </div>
    `;

    const subHeader = label =>
      `<div style="font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:#2a5a6a;margin:8px 0 4px;border-bottom:1px solid #0f2535;padding-bottom:2px;">${label}</div>`;

    return `
      <div>
        <div class="panel-title collapsible-title" onclick="toggleInventory()" style="display:flex;align-items:center;justify-content:space-between;">
          <span>Inventory</span>
          <span style="display:flex;align-items:center;gap:6px;">
            <button class="btn-add-inv" style="padding:2px 8px;font-size:0.7rem;" onclick="event.stopPropagation();addInventoryItem()">+ Item</button>
            <button class="btn-add-inv" style="padding:2px 8px;font-size:0.7rem;" onclick="event.stopPropagation();addMagicItem()">+ Magic</button>
            <span>${inventoryOpen ? '‚ñ≤' : '‚ñº'}</span>
          </span>
        </div>
        ${inventoryOpen ? `
          ${subHeader('Items')}
          ${normalItems.length === 0 ? '<div style="font-size:0.75rem;color:#2a4a5a;padding:4px 0;">Empty</div>' : normalItems.map(i => itemRow(i, false)).join('')}

          ${subHeader('Magic Items')}
          ${magicItems.length === 0 ? '<div style="font-size:0.75rem;color:#2a4a5a;padding:4px 0;">None</div>' : magicItems.map(i => itemRow(i, true)).join('')}

          ${subHeader('Attuned')}
          <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:4px;">
            <div style="display:flex;gap:4px;flex-wrap:wrap;">${pips}</div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="attuned-counter ${over ? 'over' : ''}">${attunedCount} / ${attunementMax}</span>
              <button class="btn-sm" onclick="decreaseAttunementMax()" style="padding:0 6px;">‚àí</button>
              <button class="btn-sm" onclick="increaseAttunementMax()" style="padding:0 6px;">+</button>
            </div>
          </div>
          ${attunedItems.length === 0
            ? '<div style="font-size:0.75rem;color:#2a4a5a;padding:4px 0;">No attuned items</div>'
            : attunedItems.map(i => `
              <div class="attuned-item-row">
                <div class="attuned-dot"></div>
                <span>${i.name}</span>
              </div>
            `).join('')
          }
          ${currencyRow}
        ` : ''}
      </div>
    `;
  }

  // === CUSTOM ATTACKS ===
  function addAttack() {
    const name = prompt('Attack name (e.g. Sharpshooter Shot):');
    if (!name) return;
    const hit = prompt('To Hit bonus (e.g. +7):');
    if (hit === null) return;
    const dmg = prompt('Damage (e.g. 1d8+10 piercing):') ?? '';
    const notes = prompt('Notes (e.g. -5/+10, ignore half cover) ‚Äî leave blank if none:') ?? '';
    update(s => s.attacks.push({
      id: String(Date.now()),
      name: name.trim(),
      hit: hit.trim(),
      dmg: dmg.trim(),
      notes: notes.trim()
    }));
  }
  function removeAttack(id) {
    update(s => s.attacks = s.attacks.filter(a => a.id !== id));
  }
  function editAttack(id) {
    const atk = state.attacks.find(a => a.id === id);
    if (!atk) return;
    const name = prompt('Attack name:', atk.name);
    if (name === null) return;
    const hit = prompt('To Hit:', atk.hit);
    if (hit === null) return;
    const dmg = prompt('Damage:', atk.dmg);
    const notes = prompt('Notes:', atk.notes);
    update(s => {
      const a = s.attacks.find(a => a.id === id);
      if (!a) return;
      a.name = name.trim();
      a.hit = hit.trim();
      a.dmg = (dmg ?? atk.dmg).trim();
      a.notes = (notes ?? atk.notes).trim();
    });
  }
  function renderAttacks() {
    const { attacks } = state;
    return `
      <div id="attacks-section">
        <div class="panel-title">Attacks</div>
        ${attacks.length === 0 ? '<div style="font-size:0.75rem;color:#2a4a5a;margin-bottom:8px;">None defined</div>' : ''}
        ${attacks.map(a => `
          <div class="attack-entry">
            <div class="attack-entry-header">
              <span class="attack-name" onclick="editAttack('${a.id}')" title="Click to edit">${a.name}</span>
              <button class="btn-remove-attack" onclick="removeAttack('${a.id}')">‚úï</button>
            </div>
            <div class="attack-stats">${a.hit} to hit &nbsp;¬∑&nbsp; ${a.dmg || '‚Äî'}</div>
            ${a.notes ? `<div class="attack-notes">${a.notes}</div>` : ''}
          </div>
        `).join('')}
        <button class="btn-add-attack" onclick="addAttack()">+ Add Attack</button>
      </div>
    `;
  }

  // === SKILLS ===
  const SKILL_DEFS = [
    ['Athletics',       'str', 'athletics'],
    ['Acrobatics',      'dex', 'acrobatics'],
    ['Sleight of Hand', 'dex', 'sleightOfHand'],
    ['Stealth',         'dex', 'stealth'],
    ['Arcana',          'int', 'arcana'],
    ['History',         'int', 'history'],
    ['Investigation',   'int', 'investigation'],
    ['Nature',          'int', 'nature'],
    ['Religion',        'int', 'religion'],
    ['Animal Handling', 'wis', 'animalHandling'],
    ['Insight',         'wis', 'insight'],
    ['Medicine',        'wis', 'medicine'],
    ['Perception',      'wis', 'perception'],
    ['Survival',        'wis', 'survival'],
    ['Deception',       'cha', 'deception'],
    ['Intimidation',    'cha', 'intimidation'],
    ['Performance',     'cha', 'performance'],
    ['Persuasion',      'cha', 'persuasion'],
  ];
  const ABILITY_KEYS = ['str','dex','con','int','wis','cha'];

  function cycleSkillProf(key) {
    update(s => s.skills[key] = (s.skills[key] + 1) % 3);
  }
  function toggleSkillsOpen() {
    update(s => s.skillsOpen = !s.skillsOpen);
  }
  function cycleCustomSkillProf(id) {
    update(s => { const sk = s.customSkills.find(x => x.id === id); if (sk) sk.prof = (sk.prof + 1) % 3; });
  }
  function removeCustomSkill(id) {
    update(s => s.customSkills = s.customSkills.filter(x => x.id !== id));
  }
  function addCustomSkill() {
    const name = prompt('Skill name:');
    if (!name?.trim()) return;
    const ab = prompt('Linked ability (str / dex / con / int / wis / cha):', 'str');
    if (!ab || !ABILITY_KEYS.includes(ab.trim().toLowerCase())) {
      alert('Enter one of: str, dex, con, int, wis, cha');
      return;
    }
    update(s => s.customSkills.push({ id: String(Date.now()), name: name.trim(), abilityKey: ab.trim().toLowerCase(), prof: 0 }));
  }

  function setSkillBonus(key, abilityMod, profBonus, pipState) {
    const current = state.skillBonuses[key] ?? 0;
    const calcBase = abilityMod + (pipState === 2 ? profBonus * 2 : pipState === 1 ? profBonus : 0);
    const val = prompt(`Flat bonus for ${key} (added on top of calculated ${calcBase >= 0 ? '+' : ''}${calcBase}):`, current);
    if (val === null) return;
    const n = parseInt(val) || 0;
    update(s => { s.skillBonuses[key] = n; });
  }
  function skillRow(label, abilityKey, pipState, onPipClick, onRemove, bonusKey) {
    const abilityScore = state.stats[abilityKey] ?? 10;
    const abilityMod = Math.floor((abilityScore - 10) / 2);
    const profBonus = pipState === 2 ? state.profBonus * 2 : pipState === 1 ? state.profBonus : 0;
    const flatBonus = bonusKey ? (state.skillBonuses[bonusKey] ?? 0) : 0;
    const total = abilityMod + profBonus + flatBonus;
    const sign = total >= 0 ? '+' : '';
    const pipCls = pipState === 2 ? 'expertise' : pipState === 1 ? 'prof' : '';
    const pipTitle = ['Not proficient', 'Proficient', 'Expertise'][pipState];
    const pipStyle = flatBonus !== 0 ? 'background:#a03030;border-color:#c04040;' : '';
    const bonusOnClick = bonusKey ? `setSkillBonus('${bonusKey}',${abilityMod},${state.profBonus},${pipState})` : '';
    return `
      <div class="save-row" style="padding:3px 0;">
        <span style="display:flex;align-items:center;gap:5px;">
          <span class="prof-pip ${pipCls}" onclick="${onPipClick}" title="${pipTitle}" style="${pipStyle}"></span>
          <span class="save-name" style="font-size:0.7rem;">${label}</span>
          ${onRemove ? `<span style="font-size:0.58rem;color:#2a5a6a;text-transform:uppercase;">${abilityKey}</span>` : ''}
        </span>
        <span style="display:flex;align-items:center;gap:4px;">
          <span class="stat-value" style="font-size:0.78rem;font-weight:500;${bonusKey ? 'cursor:pointer;' : ''}" ${bonusOnClick ? `onclick="${bonusOnClick}" title="Click to set flat bonus${flatBonus !== 0 ? ' (current: ' + (flatBonus >= 0 ? '+' : '') + flatBonus + ')' : ''}"` : ''}>${sign}${total}${flatBonus !== 0 ? `<span style="font-size:0.65rem;color:#c8904a;margin-left:2px;">${flatBonus >= 0 ? '+' : ''}${flatBonus}</span>` : ''}</span>
          ${onRemove ? `<button onclick="${onRemove}" style="background:none;border:none;color:#2a4a5a;cursor:pointer;font-size:0.75rem;padding:0 2px;" title="Remove">‚úï</button>` : ''}
        </span>
      </div>
    `;
  }

  function renderSkills() {
    const { skills, customSkills, skillsOpen } = state;
    const builtInRows = SKILL_DEFS.map(([label, abilityKey, stateKey]) =>
      skillRow(label, abilityKey, skills[stateKey] ?? 0, `cycleSkillProf('${stateKey}')`, null, stateKey)
    ).join('');
    const customRows = customSkills.map(sk =>
      skillRow(sk.name, sk.abilityKey, sk.prof, `cycleCustomSkillProf('${sk.id}')`, `removeCustomSkill('${sk.id}')`, null)
    ).join('');
    return `
      <div style="margin-top:4px;">
        <div class="panel-title collapsible-title" onclick="toggleSkillsOpen()">
          <span>Skills</span>
          <span>${skillsOpen ? '‚ñ≤' : '‚ñº'}</span>
        </div>
        ${skillsOpen ? `
          ${builtInRows}
          ${customRows}
          <button class="btn-add-inv" onclick="addCustomSkill()" style="margin-top:8px;">+ Add Custom Skill</button>
        ` : ''}
      </div>
    `;
  }

  // === ACTIVE SPELLS ===
  function toggleHpEffect(key) {
    update(s => {
      const fx = s.hpEffects[key];
      const val = Math.max(0, fx.value);
      if (fx.active) {
        // Turning OFF
        if (key === 'maxHpReduction') {
          s.hp.max = Math.max(1, s.hp.max + val);
        } else {
          s.hp.max = Math.max(1, s.hp.max - val);
          s.hp.current = Math.min(s.hp.current, s.hp.max);
        }
        fx.active = false;
      } else {
        // Turning ON
        if (key === 'maxHpReduction') {
          s.hp.max = Math.max(1, s.hp.max - val);
          s.hp.current = Math.min(s.hp.current, s.hp.max);
        } else {
          s.hp.max += val;
          s.hp.current += val;
        }
        fx.active = true;
      }
    });
  }
  function setHpEffectValue(key, raw) {
    const n = parseInt(raw);
    if (!isNaN(n) && n >= 0 && !state.hpEffects[key].active) {
      state.hpEffects[key].value = n;
      saveState();
    }
  }
  function toggleStatus() {
    update(s => s.statusOpen = !s.statusOpen);
  }

  function toggleSpellsSection() {
    update(s => s.spellsOpen = !s.spellsOpen);
  }
  // Auto-strain threshold effects ‚Äî shown in Effects section
  const STRAIN_EFFECTS = [
    { type: 'body', threshold: 1, label: 'Disadv. STR/DEX checks',    color: '#FF4DA6' },
    { type: 'body', threshold: 3, label: 'Speed halved',               color: '#FF4DA6' },
    { type: 'body', threshold: 5, label: 'Disadv. STR/DEX saves',      color: '#FF4DA6' },
    { type: 'body', threshold: 7, label: 'HP max halved',              color: '#FF4DA6' },
    { type: 'mind', threshold: 1, label: "Can't Dash/Disengage/Dodge", color: '#4DD9FF' },
    { type: 'mind', threshold: 3, label: 'No skill proficiency',       color: '#4DD9FF' },
    { type: 'mind', threshold: 5, label: '‚àí5 penalty to AC',           color: '#4DD9FF' },
    { type: 'mind', threshold: 7, label: 'No save proficiency',        color: '#4DD9FF' },
    { type: 'soul', threshold: 1, label: 'Disadv. WIS/CHA checks',    color: '#9B59FF' },
    { type: 'soul', threshold: 3, label: 'Disadv. on death saves',     color: '#9B59FF' },
    { type: 'soul', threshold: 5, label: 'Disadv. WIS/CHA saves',     color: '#9B59FF' },
    { type: 'soul', threshold: 7, label: 'Half supernatural healing',  color: '#9B59FF' },
  ];

  function renderStatus() {
    const spells = state.activeSpells;
    const open = state.statusOpen;
    const spellsOpen = state.spellsOpen;

    // Auto-strain condition badges
    const activeStrainEffects = STRAIN_EFFECTS.filter(ef => (state.strain[ef.type] || 0) >= ef.threshold);
    const strainFxBody = activeStrainEffects.length === 0 ? '' : `
      <div style="margin-bottom:8px;">
        <div style="font-size:0.65rem;color:#4a7a8a;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:5px;">Strain Conditions</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;">
          ${activeStrainEffects.map(ef => `
            <span style="font-size:0.7rem;background:${ef.color}22;border:1px solid ${ef.color};color:${ef.color};padding:2px 6px;border-radius:4px;white-space:nowrap;">${ef.label}</span>
          `).join('')}
        </div>
      </div>
    `;

    const spellsBody = `
      ${activeStrainEffects.length > 0 ? strainFxBody : ''}
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:${spellsOpen ? '6px' : '0'};">
        <span style="font-size:0.65rem;color:#4a7a8a;text-transform:uppercase;letter-spacing:0.1em;">Manual Effects</span>
        <span style="display:flex;gap:4px;align-items:center;">
          ${spellsOpen ? `<button class="btn-sm" onclick="addActiveSpell()">+</button>` : ''}
          <button class="btn-sm" onclick="toggleSpellsSection()" style="padding:0 5px;">${spellsOpen ? '‚ñ≤' : '‚ñº'}</button>
        </span>
      </div>
      ${spellsOpen ? `
        ${spells.length === 0 ? '<div class="no-spells">None active</div>' : ''}
        ${spells.map((sp, i) => `
          <div class="active-spell">
            <span class="spell-name">${sp.name}</span>
            ${sp.concentration ? '<span class="conc-badge">C</span>' : ''}
            <button class="spell-remove" onclick="removeActiveSpell(${i})" title="End effect">‚úï</button>
          </div>
        `).join('')}
      ` : ''}
    `;

    const fx = state.hpEffects;
    const hpFxBody = `
      <div style="border-top:1px solid #0f2535;margin:10px 0 8px;"></div>
      <div style="font-size:0.65rem;color:#4a7a8a;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;">HP Effects</div>
      ${[
        { key: 'aid',            label: 'Aid',           color: '#2a8a6a' },
        { key: 'heroesFeast',    label: "Heroes' Feast",  color: '#2a8a6a' },
        { key: 'maxHpReduction', label: 'Max HP ‚àí',      color: '#8a2a2a' },
      ].map(({ key, label, color }) => {
        const ef = fx[key];
        return `
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
            <span style="flex:1;font-size:0.8rem;color:#8ab8c8;">${label}</span>
            <input type="number" min="0" value="${ef.value}"
              onchange="setHpEffectValue('${key}', this.value)"
              ${ef.active ? 'disabled' : ''}
              style="width:42px;background:${ef.active ? '#0a1e2a' : '#0f2535'};border:1px solid #1a3a4a;color:${ef.active ? '#4a7a8a' : '#8ab8c8'};padding:2px 4px;border-radius:3px;font-size:0.8rem;text-align:right;">
            <button class="btn-sm" onclick="toggleHpEffect('${key}')"
              style="padding:2px 8px;background:${ef.active ? color : 'transparent'};border:1px solid ${color};color:${ef.active ? '#fff' : color};border-radius:3px;font-size:0.75rem;cursor:pointer;">
              ${ef.active ? 'ON' : 'OFF'}
            </button>
          </div>
        `;
      }).join('')}
    `;

    const condsBody = `
      <div style="border-top:1px solid #0f2535;margin:10px 0 8px;"></div>
      ${renderConditions()}
    `;

    document.getElementById('status-section').innerHTML = `
      <div class="panel-title" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Effects</span>
        <button class="btn-sm" onclick="toggleStatus()">${open ? '‚ñ≤' : '‚ñº'}</button>
      </div>
      ${open ? spellsBody + hpFxBody + condsBody : ''}
    `;
  }
  function addActiveSpell() {
    const name = prompt('Spell name:');
    if (!name || !name.trim()) return;
    const isConc = confirm(`Is ${name.trim()} a Concentration spell?`);
    if (isConc) {
      const existing = state.activeSpells.findIndex(s => s.concentration);
      if (existing >= 0) {
        if (!confirm(`Drop ${state.activeSpells[existing].name} and concentrate on ${name.trim()}?`)) return;
        update(s => {
          s.activeSpells.splice(existing, 1);
          s.activeSpells.push({ name: name.trim(), concentration: true });
        });
        return;
      }
    }
    update(s => s.activeSpells.push({ name: name.trim(), concentration: isConc }));
  }
  function removeActiveSpell(idx) {
    update(s => s.activeSpells.splice(idx, 1));
  }
  function toggleSpellsSection() {
    update(s => s.spellsOpen = !s.spellsOpen);
  }

  // === STRAIN TRACKER ===
  function renderStrain() {
    const { strain, strainMax, manifestDie, strainOpen } = state;
    const total = strain.body + strain.mind + strain.soul;
    const isWarning = total >= strainMax - 2;

    const pipRow = (type) => {
      const val = strain[type];
      const pips = Array.from({ length: 8 }, (_, i) =>
        `<span class="strain-pip ${i < val ? 'filled ' + type : ''}"
          onclick="adjustStrain('${type}', ${i + 1})" title="${type} strain ${i + 1}">üß†</span>`
      ).join('');
      return `
        <div class="strain-row">
          <span class="strain-label ${type}">${type}</span>
          <div class="strain-pips">${pips}</div>
          <button class="strain-adj" onclick="adjustStrain('${type}', -1)" title="Remove ${type} strain">‚àí</button>
          <button class="strain-adj" onclick="adjustStrain('${type}', 1)" title="Add ${type} strain">+</button>
        </div>`;
    };

    const section = document.getElementById('strain-section');
    if (!section) return;
    section.innerHTML = sectionTitle('Strain', 'strainOpen', 'toggleStrainOpen', strainOpen) + `
      ${strainOpen ? `
        <div class="strain-total ${isWarning ? 'warning' : ''}">
          Total Strain: <strong>${total}</strong> / <strong onclick="editStrainMax()" title="Click to edit" style="cursor:pointer;text-decoration:underline dotted;">${strainMax}</strong>
          ${total >= strainMax ? ' ‚ö† MAXIMUM REACHED' : ''}
        </div>
        <div class="strain-section">
          ${pipRow('body')}
          ${pipRow('mind')}
          ${pipRow('soul')}
        </div>
        <div class="manifest-die-display" onclick="editManifestDie()" title="Click to edit" style="cursor:pointer;">Manifestation Die: <span>${manifestDie}</span></div>
      ` : ''}`;
  }

  function adjustStrain(type, delta) {
    update(s => {
      if (delta === -1) {
        s.strain[type] = Math.max(0, s.strain[type] - 1);
      } else if (delta > 0 && delta <= 8) {
        s.strain[type] = s.strain[type] === delta ? delta - 1 : delta;
      } else {
        s.strain[type] = Math.min(8, s.strain[type] + 1);
      }
    });
    renderStatus();
  }

  // === ACTIVE POWERS ===
  function renderActivePowers() {
    const { knownPowers, concentration, powersOpen } = state;
    const activePowers = POWERS_DATA.filter(p => knownPowers.includes(p.id));

    const makeCard = p => {
      const isConc = concentration.includes(p.id);
      const isOpen = !!powerCardOpen[p.id];
      const desc = POWER_DESCRIPTIONS[p.id] || '';
      const timeLabel = { action: 'Action', bonus: 'Bonus', reaction: 'Reaction', special: 'Special' }[p.manifestTime] || p.manifestTime;
      return `
        <div class="power-card" style="flex-direction:column;align-items:stretch;gap:0;padding:0;">
          <div style="display:flex;align-items:center;gap:6px;padding:7px 8px;cursor:pointer;" onclick="togglePowerCard('${p.id}')">
            <span class="power-name">
              ${p.name}
              <span class="power-school">${p.school} ¬∑ ${timeLabel}${p.concentration ? ' ¬∑ C' : ''}</span>
            </span>
            ${p.concentration ? `
              <button class="power-conc-toggle ${isConc ? 'active' : ''}"
                onclick="event.stopPropagation();toggleConcentration('${p.id}')" title="Toggle concentration">C</button>
            ` : ''}
            <button class="power-manifest-btn" onclick="event.stopPropagation();openManifestModal('${p.id}')">Manifest</button>
            <span style="font-size:0.65rem;color:#2a5a6a;padding-left:2px;">${isOpen ? '‚ñ≤' : '‚ñº'}</span>
          </div>
          ${isOpen && desc ? `
            <div style="border-top:1px solid #0f2535;padding:7px 10px 8px;font-size:0.75rem;color:#7ab8c8;line-height:1.5;">
              ${desc}
            </div>
          ` : ''}
        </div>`;
    };

    const cards = [1, 2, 3, 4, 5, 6].map(order => {
      const group = activePowers.filter(p => p.order === order);
      if (!group.length) return '';
      const ordinal = ['', '1st', '2nd', '3rd', '4th', '5th', '6th'][order];
      return `
        <div class="order-group">
          <div class="order-group-title">${ordinal} Order</div>
          ${group.map(makeCard).join('')}
        </div>`;
    }).join('');

    const section = document.getElementById('powers-section');
    if (!section) return;
    section.innerHTML = sectionTitle('Active Powers', 'powersOpen', 'togglePowersOpen', powersOpen) + `
      ${powersOpen ? `
        <div class="powers-section">
          ${activePowers.length === 0
            ? `<div style="font-size:0.75rem;color:#2a5a6a;text-align:center;padding:12px">No powers selected ‚Äî use Manage Powers to add them</div>`
            : cards}
          <button class="powers-manage-btn" onclick="openManagePowers()">‚öô Manage Powers</button>
        </div>
      ` : ''}`;
  }

  function toggleConcentration(id) {
    update(s => {
      const idx = s.concentration.indexOf(id);
      if (idx >= 0) s.concentration.splice(idx, 1);
      else s.concentration.push(id);
    });
  }

  function openManifestModal(id) {
    const power = POWERS_DATA.find(p => p.id === id);
    if (!power) return;
    document.getElementById('manifest-modal').style.display = 'flex';
    renderManifestModal(power);
  }

  function openManagePowers() {
    document.getElementById('manage-powers-modal').style.display = 'flex';
    renderManagePowersModal();
  }

  let powerCardOpen = {};   // id ‚Üí true when description is expanded

  function togglePowerCard(id) {
    powerCardOpen[id] = !powerCardOpen[id];
    renderActivePowers();
  }

  // === MANAGE POWERS MODAL ===
  let managePowersFilter = { search: '', school: '' };

  function renderManagePowersModal() {
    const modal = document.getElementById('manage-powers-modal');
    const { search, school } = managePowersFilter;
    const schools = ['Chronopathy', 'Metamorphosis', 'Pyrokinesis', 'Resopathy', 'Telekinesis', 'Telepathy'];

    const filtered = POWERS_DATA.filter(p =>
      (!search || p.name.toLowerCase().includes(search.toLowerCase())) &&
      (!school || p.school === school)
    );

    const byOrder = [1, 2, 3, 4, 5, 6].map(order => {
      const powers = filtered.filter(p => p.order === order);
      if (!powers.length) return '';
      const ordinal = ['', '1st', '2nd', '3rd', '4th', '5th', '6th'][order];
      const rows = powers.map(p => `
        <div class="power-pick-row">
          <input type="checkbox" class="power-pick-checkbox"
            ${state.knownPowers.includes(p.id) ? 'checked' : ''}
            onchange="toggleKnownPower('${p.id}', this.checked)">
          <span class="power-pick-name">${p.name}</span>
          <span class="power-pick-school">${p.school}</span>
          <span class="power-pick-time">${p.manifestTime}</span>
        </div>`).join('');
      return `<div class="order-group"><div class="order-group-title">${ordinal} Order</div>${rows}</div>`;
    }).join('');

    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-box">
        <div class="modal-header">
          <div class="modal-title">
            Manage Powers
            <button class="modal-close" onclick="closeManagePowers()">‚úï</button>
          </div>
          <input class="modal-search" placeholder="Search powers..."
            value="${search}" oninput="managePowersSearch(this.value)">
          <div class="school-filter">
            <button class="school-btn ${!school ? 'active' : ''}" onclick="managePowersSchool('')">All</button>
            ${schools.map(s => `<button class="school-btn ${school === s ? 'active' : ''}" onclick="managePowersSchool('${s}')">${s}</button>`).join('')}
          </div>
        </div>
        <div class="modal-body">
          ${byOrder || '<div style="color:#2a5a6a;text-align:center;padding:20px">No powers match</div>'}
        </div>
        <div class="modal-footer">
          <button class="powers-manage-btn" onclick="closeManagePowers()" style="width:100%;margin:0;">Done</button>
        </div>
      </div>`;
  }

  function toggleKnownPower(id, checked) {
    update(s => {
      if (checked && !s.knownPowers.includes(id)) s.knownPowers.push(id);
      if (!checked) {
        s.knownPowers = s.knownPowers.filter(p => p !== id);
        s.concentration = s.concentration.filter(p => p !== id);
      }
    });
    renderActivePowers();
  }

  function managePowersSearch(val) {
    managePowersFilter.search = val;
    renderManagePowersModal();
  }

  function managePowersSchool(val) {
    managePowersFilter.school = val;
    renderManagePowersModal();
  }

  function closeManagePowers() {
    document.getElementById('manage-powers-modal').style.display = 'none';
    managePowersFilter = { search: '', school: '' };
  }

  // === MANIFESTATION RESOLVER ===
  let manifestState = { power: null, step: 1, roll: null, strainGained: 0, allocated: { body: 0, mind: 0, soul: 0 } };

  function renderManifestModal(power) {
    manifestState = { power, step: 1, roll: null, strainGained: 0, allocated: { body: 0, mind: 0, soul: 0 } };
    _drawManifestModal();
  }

  function _drawManifestModal() {
    const modal = document.getElementById('manifest-modal');
    const { power, step, roll, strainGained, allocated } = manifestState;
    const { concentration, strain, strainMax } = state;

    const concCount = concentration.filter(id => id !== power.id).length;
    const score = power.order + concCount;
    const total = strain.body + strain.mind + strain.soul;
    const allocTotal = allocated.body + allocated.mind + allocated.soul;
    const dieLabel = state.manifestDie.toUpperCase();

    if (power.order === 1) {
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-box resolver-box">
          <div class="modal-title">${power.name} <button class="modal-close" onclick="closeManifestModal()">‚úï</button></div>
          <div style="text-align:center;padding:16px">
            <div style="font-size:0.8rem;color:#4a7a8a;margin-bottom:8px">1st-order power ‚Äî no manifestation test required.</div>
            <div class="resolver-result success">‚úì Power manifested. No strain.</div>
            <button class="resolver-confirm-btn" style="margin-top:12px" onclick="closeManifestModal()">Done</button>
          </div>
        </div>`;
      return;
    }

    let body = '';
    if (step === 1) {
      const concNames = concentration.filter(id => id !== power.id)
        .map(id => POWERS_DATA.find(p => p.id === id)?.name).filter(Boolean);
      body = `
        <div class="resolver-step">
          <div class="resolver-score">
            Score: ${score}
            <small>Order ${power.order}${concCount > 0 ? ` + ${concCount} (concentrating on ${concNames.join(', ')})` : ''}</small>
          </div>
          <div style="font-size:0.75rem;color:#4a7a8a;text-align:center;margin-bottom:12px">
            Roll your ${dieLabel}. If roll &gt; ${score}: no strain. If = ${score}: +1 strain. If &lt; ${score}: +${power.order} strain.
          </div>
          <button class="resolver-roll-btn" onclick="manifestRollForMe()">üé≤ Roll ${dieLabel} for me</button>
          <div style="text-align:center;margin:8px 0;font-size:0.7rem;color:#4a7a8a">‚Äî or enter your roll ‚Äî</div>
          <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
            ${Array.from({ length: parseInt(state.manifestDie.slice(1)) }, (_, i) =>
              `<button class="strain-adj" onclick="manifestSetRoll(${i + 1})" style="width:28px">${i + 1}</button>`
            ).join('')}
          </div>
        </div>`;
    } else if (step === 2) {
      const wouldExceed = total + strainGained > strainMax;
      let resultClass, resultText;
      if (roll > score)       { resultClass = 'success'; resultText = `‚úì ${roll} > ${score} ‚Äî Success! No strain.`; }
      else if (roll === score) { resultClass = 'partial'; resultText = `~ ${roll} = ${score} ‚Äî Success + 1 strain`; }
      else                     { resultClass = 'failure'; resultText = `‚úó ${roll} < ${score} ‚Äî Success + ${strainGained} strain (order ${power.order})`; }

      if (wouldExceed && strainGained > 0) {
        body = `
          <div class="resolver-result death-warning">
            ‚ö† Gaining ${strainGained} strain would exceed your maximum (${total} + ${strainGained} &gt; ${strainMax}).
            <div style="margin-top:8px;font-size:0.8rem">Choose:</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="resolver-confirm-btn" onclick="manifestAndDie()">Manifest &amp; Die</button>
            <button class="resolver-confirm-btn" onclick="manifestCancel()">Cancel (drop to 0 HP)</button>
          </div>`;
      } else if (strainGained === 0) {
        body = `
          <div class="resolver-result ${resultClass}">${resultText}</div>
          <button class="resolver-confirm-btn" style="margin-top:8px" onclick="closeManifestModal()">Done ‚úì</button>`;
      } else {
        body = `
          <div class="resolver-result ${resultClass}">${resultText}</div>
          <div style="margin:12px 0;font-size:0.8rem;color:#4a7a8a;text-align:center">Distribute ${strainGained} strain:</div>
          <div class="alloc-tally">${allocTotal} / ${strainGained} allocated</div>
          <div class="strain-alloc">
            <button class="strain-alloc-btn body" onclick="manifestAlloc('body')">+Body (${allocated.body})</button>
            <button class="strain-alloc-btn mind" onclick="manifestAlloc('mind')">+Mind (${allocated.mind})</button>
            <button class="strain-alloc-btn soul" onclick="manifestAlloc('soul')">+Soul (${allocated.soul})</button>
          </div>
          <button class="resolver-confirm-btn" ${allocTotal < strainGained ? 'disabled' : ''} onclick="manifestConfirmStrain()">
            Confirm Strain
          </button>`;
      }
    }

    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-box resolver-box">
        <div class="modal-title">
          Manifest: ${power.name}
          <button class="modal-close" onclick="closeManifestModal()">‚úï</button>
        </div>
        <div style="font-size:0.7rem;color:#4a7a8a;margin-bottom:12px">
          ${power.school} &bull; ${['','1st','2nd','3rd','4th','5th','6th'][power.order]} Order
          ${power.concentration ? ' &bull; <span style="color:#FF4DA6">Concentration</span>' : ''}
        </div>
        ${body}
      </div>`;
  }

  function manifestRollForMe() {
    const sides = parseInt(state.manifestDie.slice(1));
    manifestSetRoll(Math.ceil(Math.random() * sides));
  }

  function manifestSetRoll(roll) {
    const { power } = manifestState;
    const concCount = state.concentration.filter(id => id !== power.id).length;
    const score = power.order + concCount;
    let strainGained = 0;
    if (roll === score) strainGained = 1;
    if (roll < score)  strainGained = power.order;
    manifestState = { ...manifestState, step: 2, roll, strainGained, allocated: { body: 0, mind: 0, soul: 0 } };
    _drawManifestModal();
  }

  function manifestAlloc(type) {
    const { strainGained, allocated } = manifestState;
    const total = allocated.body + allocated.mind + allocated.soul;
    if (total >= strainGained) return;
    manifestState.allocated[type]++;
    _drawManifestModal();
  }

  function manifestConfirmStrain() {
    const { allocated } = manifestState;
    update(s => {
      s.strain.body = Math.min(8, s.strain.body + allocated.body);
      s.strain.mind = Math.min(8, s.strain.mind + allocated.mind);
      s.strain.soul = Math.min(8, s.strain.soul + allocated.soul);
    });
    closeManifestModal();
    renderStrain();
    renderStatus();
  }

  function manifestAndDie() {
    const { allocated } = manifestState;
    update(s => {
      s.strain.body = Math.min(8, s.strain.body + allocated.body);
      s.strain.mind = Math.min(8, s.strain.mind + allocated.mind);
      s.strain.soul = Math.min(8, s.strain.soul + allocated.soul);
      s.hp.current = 0;
    });
    closeManifestModal();
    render();
  }

  function manifestCancel() {
    update(s => s.hp.current = 0);
    closeManifestModal();
    render();
  }

  function closeManifestModal() {
    document.getElementById('manifest-modal').style.display = 'none';
    manifestState = { power: null, step: 1, roll: null, strainGained: 0, allocated: { body: 0, mind: 0, soul: 0 } };
  }

  // === COLUMN DRAG STATE ===
  let colDragState = null;

  document.addEventListener('mousemove', e => {
    const z = panelZoom();
    const mx = e.clientX / z, my = e.clientY / z;
    if (draggingPanel) {
      const panel = document.getElementById('stat-panel');
      panel.style.left = (mx - dragOffsetX) + 'px';
      panel.style.top  = Math.max(0, (my - dragOffsetY)) + 'px';
    }
    if (draggingLore) {
      const panel = document.getElementById('lore-panel');
      panel.style.left = (mx - loreDragOffsetX) + 'px';
      panel.style.top  = Math.max(0, (my - loreDragOffsetY)) + 'px';
    }
    if (panelResizeState) {
      const { edge, startX, startY, startW, startH, startLeft, startTop } = panelResizeState;
      const dx = mx - startX;
      const dy = my - startY;
      const panel = document.getElementById('stat-panel');
      if (edge.includes('e'))  panel.style.width  = Math.max(280, startW + dx) + 'px';
      if (edge.includes('s'))  panel.style.height = Math.max(160, startH + dy) + 'px';
      if (edge.includes('w')) {
        const newW = Math.max(280, startW - dx);
        panel.style.width = newW + 'px';
        panel.style.left  = (startLeft + startW - newW) + 'px';
      }
      if (edge.includes('n')) {
        const newH = Math.max(160, startH - dy);
        const rawTop = startTop + startH - newH;
        const clampedTop = Math.max(0, rawTop);
        panel.style.height = (newH - (clampedTop - rawTop)) + 'px';
        panel.style.top    = clampedTop + 'px';
      }
    }
    if (loreResizeState) {
      const { edge, startX, startY, startW, startH, startLeft, startTop } = loreResizeState;
      const dx = mx - startX;
      const dy = my - startY;
      const panel = document.getElementById('lore-panel');
      if (edge.includes('e'))  panel.style.width  = Math.max(280, startW + dx) + 'px';
      if (edge.includes('s'))  panel.style.height = Math.max(160, startH + dy) + 'px';
      if (edge.includes('w')) {
        const newW = Math.max(280, startW - dx);
        panel.style.width = newW + 'px';
        panel.style.left  = (startLeft + startW - newW) + 'px';
      }
      if (edge.includes('n')) {
        const newH = Math.max(160, startH - dy);
        const rawTop = startTop + startH - newH;
        const clampedTop = Math.max(0, rawTop);
        panel.style.height = (newH - (clampedTop - rawTop)) + 'px';
        panel.style.top    = clampedTop + 'px';
      }
    }
    if (!colDragState) return;
    const cols = document.querySelector('.columns');
    const totalW = cols.offsetWidth;
    const dx = e.clientX - colDragState.startX;
    if (colDragState.side === 'left') {
      colDragState.currentLeftW = Math.max(180, Math.min(
        colDragState.startLeftW + dx,
        totalW - colDragState.startRightW - 200
      ));
    } else {
      colDragState.currentRightW = Math.max(220, Math.min(
        colDragState.startRightW - dx,
        totalW - colDragState.startLeftW - 200
      ));
    }
    applyColWidths(colDragState.currentLeftW, colDragState.currentRightW);
  });
  document.addEventListener('mouseup', () => {
    if (draggingPanel || panelResizeState || draggingLore || loreResizeState) {
      draggingPanel = false;
      panelResizeState = null;
      draggingLore = false;
      loreResizeState = null;
      document.getElementById('drag-shield').classList.remove('active');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
    if (colDragState) {
      const { currentLeftW, currentRightW } = colDragState;
      document.querySelectorAll('.col-handle').forEach(h => h.classList.remove('dragging'));
      colDragState = null;
      update(s => { s.layout.leftW = currentLeftW; s.layout.rightW = currentRightW; });
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });

  document.addEventListener('dragover', e => {
    e.preventDefault();
    document.querySelector('.drop-hint-strip')?.classList.add('drag-over');
    document.querySelector('.stat-preview-hint')?.classList.add('drag-over');
  });
  document.addEventListener('dragleave', e => {
    if (!e.relatedTarget || e.relatedTarget === document.documentElement) {
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }
  });
  document.addEventListener('drop', handleFileDrop);

  // === COLUMN DRAG HANDLES ===

  function applyColWidths(leftW, rightW) {
    leftW = leftW ?? state.layout.leftW;
    rightW = rightW ?? state.layout.rightW;
    const cols = document.querySelector('.columns');
    if (!cols) return;
    cols.style.gridTemplateColumns = `${leftW}px 1fr ${rightW}px`;
    const h1 = document.getElementById('col-handle-1');
    const h2 = document.getElementById('col-handle-2');
    if (h1) h1.style.left = leftW + 'px';
    if (h2) h2.style.left = (cols.offsetWidth - rightW) + 'px';
  }

  function initColHandles() {
    const cols = document.querySelector('.columns');
    ['col-handle-1', 'col-handle-2'].forEach(id => {
      if (!document.getElementById(id)) {
        const h = document.createElement('div');
        h.className = 'col-handle';
        h.id = id;
        cols.appendChild(h);
      }
    });
    document.getElementById('col-handle-1').onmousedown = e => startColDrag(e, 'left');
    document.getElementById('col-handle-2').onmousedown = e => startColDrag(e, 'right');
    applyColWidths();
  }

  function startColDrag(e, side) {
    e.preventDefault();
    e.stopPropagation();
    colDragState = {
      side,
      startX: e.clientX,
      startLeftW: state.layout.leftW,
      startRightW: state.layout.rightW,
      currentLeftW: state.layout.leftW,
      currentRightW: state.layout.rightW
    };
    e.currentTarget.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  }


  // === LORE BOOK ===
  function addLorePage() {
    const title = prompt('Page title:');
    if (!title?.trim()) return;
    const id = Date.now().toString();
    update(s => {
      s.loreBook.push({ id, title: title.trim(), content: '' });
      s.loreActiveId = id;
    });
    renderLorePanel();
  }

  function renameLorePage() {
    if (!state.loreActiveId) return;
    const page = state.loreBook.find(p => p.id === state.loreActiveId);
    if (!page) return;
    const val = prompt('Rename page:', page.title);
    if (val?.trim()) {
      update(s => s.loreBook.find(p => p.id === state.loreActiveId).title = val.trim());
      renderLorePanel();
    }
  }

  function deleteLorePage() {
    if (!state.loreActiveId) return;
    const page = state.loreBook.find(p => p.id === state.loreActiveId);
    if (!page || !confirm(`Delete page "${page.title}"?`)) return;
    update(s => {
      s.loreBook = s.loreBook.filter(p => p.id !== state.loreActiveId);
      s.loreActiveId = s.loreBook.length > 0 ? s.loreBook[s.loreBook.length - 1].id : null;
    });
    renderLorePanel();
  }

  function switchLorePage(id) {
    update(s => s.loreActiveId = id);
    lorePageMenuOpen = false;
    document.getElementById('lore-page-menu')?.classList.add('hidden');
    renderLorePanel();
  }

  function updateLoreContent(value) {
    if (!state.loreActiveId) return;
    update(s => {
      const page = s.loreBook.find(p => p.id === state.loreActiveId);
      if (page) page.content = value;
    });
  }

  function renderLorePanel() {
    const { loreBook, loreActiveId } = state;
    const activePage = loreBook.find(p => p.id === loreActiveId) || null;

    // Update page dropdown button label
    const pageBtn = document.getElementById('lore-page-btn');
    if (pageBtn) pageBtn.textContent = activePage ? activePage.title + ' ‚ñæ' : '‚Äî no pages ‚Äî ‚ñæ';

    // Rebuild page menu
    const menu = document.getElementById('lore-page-menu');
    if (menu) {
      menu.innerHTML = loreBook.map(p =>
        `<button class="${p.id === loreActiveId ? 'mat-active' : ''}" onclick="switchLorePage('${p.id}')">${p.title}</button>`
      ).join('') + (loreBook.length > 0 ? '<hr class="mat-divider">' : '') +
      `<button onclick="addLorePage()">+ Add page‚Ä¶</button>`;
    }

    // Show/hide empty state and textarea
    const empty = document.getElementById('lore-empty');
    const textarea = document.getElementById('lore-textarea');
    if (!activePage) {
      if (empty) empty.style.display = 'block';
      if (textarea) textarea.style.display = 'none';
    } else {
      if (empty) empty.style.display = 'none';
      if (textarea) {
        textarea.style.display = 'block';
        textarea.value = activePage.content;
      }
    }
  }

  function exportLore() {
    const filename = 'lore-book.json';
    const blob = new Blob([JSON.stringify(state.loreBook, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importLore() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const parsed = JSON.parse(evt.target.result);
          if (!Array.isArray(parsed)) throw new Error('Expected an array of pages');
          update(s => {
            s.loreBook = parsed;
            s.loreActiveId = parsed.length > 0 ? parsed[0].id : null;
          });
          renderLorePanel();
        } catch (err) { alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  // === RENDER ===
  function render() {
    renderHeader();
    renderHP();
    renderStrain();
    renderActivePowers();
    renderStatus();
    document.getElementById('attacks-section-wrap').innerHTML = renderAttacks();
    document.getElementById('inventory-wrap').innerHTML = renderInventory();
    document.getElementById('feats-wrap').innerHTML = renderFeats();
    document.getElementById('skills-wrap').innerHTML = renderSkills();
    applyColWidths();
    renderLorePanel();
  }

  render();
  initColHandles();
  window.addEventListener('resize', () => applyColWidths());
</script>
  <div id="manage-powers-modal" style="display:none"></div>
  <div id="manifest-modal" style="display:none"></div>
</body>
</html>
